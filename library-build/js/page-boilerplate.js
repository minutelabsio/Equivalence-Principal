/** @license MIT License (c) copyright 2011-2013 original author or authors */

/**
 * A lightweight CommonJS Promises/A and when() implementation
 * when is part of the cujo.js family of libraries (http://cujojs.com/)
 *
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @author Brian Cavalier
 * @author John Hann
 * @version 2.5.1
 */

/**
 * @license RequireJS domReady 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/domReady for details
 */

// Copyright 2013 jQuery Foundation and other contributors

/*! Hammer.JS - v1.0.9 - 2014-03-18
 * http://eightmedia.github.com/hammer.js
 *
 * Copyright (c) 2014 Jorik Tangelder <j.tangelder@gmail.com>;
 * Licensed under the MIT license */

/**
 * PhysicsJS v1.0.0-rc1 - 2014-03-23
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2014 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

/**
 * @license
 * Lo-Dash 2.2.1 (Custom Build) lodash.com/license | Underscore.js 1.5.2 underscorejs.org/LICENSE
 * Build: `lodash modern exports="none" iife="(function(window){%output%;lodash.extend(Physics.util, lodash);}(this));" include="isObject,isFunction,isArray,isPlainObject,uniqueId,uniq,filter,find,each,random,defaults,extend,transform,clone,throttle,bind,sortedIndex,shuffle" --minify --output lib/lodash.js`
 */

/*!
 * Fast indexOf
 * @param  {Array} arr   The array to search
 * @param  {Mixed} value The value to find
 * @return {Number}       The index OR -1
 */

// MIT license

/*!
     * Get test function to test on sub property
     * @param  {Function} fn   The test function
     * @param  {String}   prop The property name to test
     * @return {Function}        The wrapped function
     */

/*!
     * Get an equality test function
     * @param  {Mixed} toMatch The value to match
     * @param  {String} prop    (optional) The property name to test
     * @return {Function}         The test function
     */

/*!
     * Get a NOT equality test function
     * @param  {Mixed} toMatch The value to match
     * @param  {String} prop    (optional) The property name to test
     * @return {Function}         The test function
     */

/*!
     * Get a test function for matching ANY in array
     * @param  {Mixed} toMatch The value array to match
     * @param  {String} prop    (optional) The property name to test
     * @return {Function}         The test function
     */

/*!
     * Get a test function for matching NOT ANY in array
     * @param  {Mixed} toMatch The value array to match
     * @param  {String} prop    (optional) The property name to test
     * @return {Function}         The test function
     */

/*!
     * Get a test function to match any body who's aabb intersects point
     * @param  {Vectorish} point The point to check
     * @return {Function}       The test function
     */

/*!
     * Get an AND test function
     * @param  {Function} first First function node
     * @return {Function}       Test function
     */

/*!
     * Get an OR test function
     * @param  {Function} first First function node
     * @return {function}       Test function
     */

(function(e,t){e("when/when",["require"],function(e){function n(e,t,n,i){return r(e).then(t,n,i)}function r(e){return e instanceof i?e:s(e)}function i(e,t){this._message=e,this.inspect=t}function s(e){return a(function(t){t(e)})}function o(e){return n(e,h)}function u(){function r(r,i,o){e.resolve=e.resolver.resolve=function(e){return n?s(e):(n=!0,r(e),t)},e.reject=e.resolver.reject=function(e){return n?s(h(e)):(n=!0,i(e),t)},e.notify=e.resolver.notify=function(e){return o(e),e}}var e,t,n;return e={promise:W,resolve:W,reject:W,notify:W,resolver:{resolve:W,reject:W,notify:W}},e.promise=t=a(r),e}function a(e){return f(e,R.PromiseStatus&&R.PromiseStatus())}function f(e,t){function u(e,t,n,i){function o(r){r._message(e,t,n,i)}s?s.push(o):X(function(){o(r)})}function a(){return r?r.inspect():M()}function f(e){if(!s)return;var i=s;s=W,X(function(){r=v(n,e),t&&b(r,t),l(i,r)})}function c(e){f(h(e))}function p(e){if(s){var t=s;X(function(){l(t,d(e))})}}var n,r,s=[];n=new i(u,a),n._status=t;try{e(f,c,p)}catch(o){c(o)}return n}function l(e,t){for(var n=0;n<e.length;n++)e[n](t)}function c(e){return p(new g(e),function(){return A(e)})}function h(e){return p(new y(e),function(){return O(e)})}function p(e,t){return new i(function(t,n,r){try{r(e[t].apply(e,n))}catch(i){r(h(i))}},t)}function d(e){return new i(function(t,n,r,i){var s=n[2];try{i(typeof s=="function"?s(e):e)}catch(o){i(o)}})}function v(e,t){if(t===e)return h(new TypeError);if(t instanceof i)return t;try{var n=t===Object(t)&&t.then;return typeof n=="function"?m(n,t):c(t)}catch(r){return h(r)}}function m(e,t){return a(function(n,r){P(e,t,n,r)})}function g(e){this.value=e}function y(e){this.reason=e}function b(e,t){function n(){t.fulfilled()}function r(e){t.rejected(e)}e.then(n,r)}function w(e){return e&&typeof e.then=="function"}function E(e,t,r,i,s){return n(e,function(e){function o(r,i,s){function d(e){c(e)}function v(e){l(e)}var o,u,a,f,l,c,h,p;h=e.length>>>0,o=Math.max(0,Math.min(t,h)),a=[],u=h-o+1,f=[];if(!o)r(a);else{c=function(e){f.push(e),--u||(l=c=J,i(f))},l=function(e){a.push(e),--o||(l=c=J,r(a))};for(p=0;p<h;++p)p in e&&n(e[p],v,d,s)}}return a(o).then(r,i,s)})}function S(e,t,n,r){function i(e){return t?t(e[0]):e[0]}return E(e,1,i,n,r)}function x(e,t,n,r){return k(e,J).then(t,n,r)}function T(){return k(arguments,J)}function N(e){return k(e,A,O)}function C(e,t){return k(e,t)}function k(e,t,r){return n(e,function(e){function i(i,s,o){function c(e,a){n(e,t,r).then(function(e){u[a]=e,--f||i(u)},s,o)}var u,a,f,l;f=a=e.length>>>0,u=[];if(!f){i(u);return}for(l=0;l<a;l++)l in e?c(e[l],l):--f}return f(i)})}function L(e,t){var r=P(D,arguments,1);return n(e,function(e){var i;return i=e.length,r[0]=function(e,r,s){return n(e,function(e){return n(r,function(n){return t(e,n,s,i)})})},_.apply(e,r)})}function A(e){return{state:"fulfilled",value:e}}function O(e){return{state:"rejected",reason:e}}function M(){return{state:"pending"}}function X(e){B.push(e)===1&&H(V)}function V(){l(B),B=[]}function J(e){return e}n.promise=a,n.resolve=s,n.reject=o,n.defer=u,n.join=T,n.all=x,n.map=C,n.reduce=L,n.settle=N,n.any=S,n.some=E,n.isPromise=w,n.isPromiseLike=w,i.prototype={then:function(e,t,n){var r,i;return r=arguments,i=this._message,f(function(e,t,n){i("when",r,e,n)},this._status&&this._status.observed())},otherwise:function(e){return this.then(W,e)},ensure:function(e){function t(){return s(e())}return typeof e=="function"?this.then(t,t).yield(this):this},yield:function(e){return this.then(function(){return e})},tap:function(e){return this.then(e).yield(this)},spread:function(e){return this.then(function(t){return x(t,function(t){return e.apply(W,t)})})},always:function(e,t){return this.then(e,e,t)}},g.prototype.when=function(e){return typeof e=="function"?e(this.value):this.value},y.prototype.when=function(e,t){if(typeof t=="function")return t(this.reason);throw this.reason};var _,D,P,H,B,j,F,I,q,R,U,z,W;U=e,B=[],j=t.setTimeout,R=typeof console!="undefined"?console:n;if(typeof process=="object"&&process.nextTick)H=process.nextTick;else if(z=t.MutationObserver||t.WebKitMutationObserver)H=function(e,t,n){var r=e.createElement("div");return(new t(n)).observe(r,{attributes:!0}),function(){r.setAttribute("x","x")}}(document,z,V);else try{H=U("vertx").runOnLoop||U("vertx").runOnContext}catch($){H=function(e){j(e,0)}}return F=Function.prototype,I=F.call,P=F.bind?I.bind(I):function(e,t){return e.apply(t,D.call(arguments,2))},q=[],D=q.slice,_=q.reduce||function(e){var t,n,r,i,s;s=0,t=Object(this),i=t.length>>>0,n=arguments;if(n.length<=1)for(;;){if(s in t){r=t[s++];break}if(++s>=i)throw new TypeError}else r=n[1];for(;s<i;++s)s in t&&(r=e(r,t[s],s,t));return r},n})})(typeof define=="function"&&define.amd?define:function(e){module.exports=e(require)},this),define("when",["when/when"],function(e){return e}),define("plugins/domready",[],function(){function u(e){var t;for(t=0;t<e.length;t+=1)e[t](s)}function a(){var e=o;i&&e.length&&(o=[],u(e))}function f(){i||(i=!0,n&&clearInterval(n),a())}function c(e){return i?e(s):o.push(e),c}var e,t,n,r=typeof window!="undefined"&&window.document,i=!r,s=r?document:null,o=[];if(r){if(document.addEventListener)document.addEventListener("DOMContentLoaded",f,!1),window.addEventListener("load",f,!1);else if(window.attachEvent){window.attachEvent("onload",f),t=document.createElement("div");try{e=window.frameElement===null}catch(l){}t.doScroll&&e&&window.external&&(n=setInterval(function(){try{t.doScroll(),f()}catch(e){}},30))}document.readyState==="complete"&&f()}return c.version="2.0.1",c.load=function(e,t,n,r){r.isBuild?n(null):c(n)},c}),define("util/events",["when"],function(e){var t;return Function.prototype.bind?t=function(t,n){return t.bind(n)}:t=function(t,n){return function(){return t.apply(n,arguments)}},{on:function(e,n,r){var i=this._topics||(this._topics={}),s=i[e]||(i[e]=[]),o=n,u;if(typeof e=="object"){for(var a in e)this.on(a,e[a],n,r);return this}return typeof r=="object"&&(n=t(n,r),n._bindfn_=o),s.push(n),this},off:function(e,t){var n=this._topics||(this._topics={}),r=n[e],i;if(!r)return this;for(var s=0,o=r.length;s<o;s++){i=r[s];if(i._bindfn_===t||i===t){r.splice(s,1);break}}return this},emit:function(e,t){var n=this._topics||(this._topics={}),r=n[e],i=r&&r.length,s=0,o={topic:e};if(!i)return this;while(s<i)o.handler=r[s],o.handler&&o.handler(o,t),s++;return this},after:function(t,n){var r=this._dfds||(this._dfds={}),i=r[t]||(r[t]=e.defer());return n?i.promise.then(n):i.promise},resolve:function(t,n){var r=this._dfds||(this._dfds={}),i=r[t]||(r[t]=e.defer());return i.resolve(n),this}}}),define("moddef",["util/events"],function(e){var t={}.hasOwnProperty,n={events:e},r=function(t){return typeof t=="function"},i=Array.isArray,s=function(e){if(typeof e!="object"||e.nodeType||e===window)return!1;try{if(e.constructor&&!t.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}return!0},o=function a(){var e,t,n,o,u,f,l=arguments[0]||{},c=1,h=arguments.length,p=!1;typeof l=="boolean"&&(p=l,l=arguments[c]||{},c++),typeof l!="object"&&!r(l)&&(l={});if(c===h)return l;for(;c<h;c++)if((e=arguments[c])!=null)for(t in e){n=l[t],o=e[t];if(l===o)continue;p&&o&&(s(o)||(u=i(o)))?(u?(u=!1,f=n&&i(n)?n:[]):f=n&&s(n)?n:{},l[t]=a(p,f,o)):o!==undefined&&(l[t]=o)}return l},u=function(t,r){var i=function u(e){if(!(this instanceof u))return new u(e);this.constructor&&this.constructor(e)};i.prototype=t;if(r){var s;while(s=r.pop())i.prototype=o(i.prototype,n[s])}return i};return u}),!function(e,t){function n(){r.READY||(y.determineEventTypes(),d.each(r.gestures,function(e){w.register(e)}),y.onTouch(r.DOCUMENT,h,w.detect),y.onTouch(r.DOCUMENT,p,w.detect),r.READY=!0)}var r=function(e,t){return new r.Instance(e,t||{})};r.defaults={stop_browser_behavior:{userSelect:"none",touchAction:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}},r.HAS_POINTEREVENTS=e.navigator.pointerEnabled||e.navigator.msPointerEnabled,r.HAS_TOUCHEVENTS="ontouchstart"in e,r.MOBILE_REGEX=/mobile|tablet|ip(ad|hone|od)|android|silk/i,r.NO_MOUSEEVENTS=r.HAS_TOUCHEVENTS&&e.navigator.userAgent.match(r.MOBILE_REGEX),r.EVENT_TYPES={},r.UPDATE_VELOCITY_INTERVAL=16,r.DOCUMENT=e.document;var i=r.DIRECTION_DOWN="down",s=r.DIRECTION_LEFT="left",o=r.DIRECTION_UP="up",u=r.DIRECTION_RIGHT="right",a=r.POINTER_MOUSE="mouse",f=r.POINTER_TOUCH="touch",l=r.POINTER_PEN="pen",c=r.EVENT_START="start",h=r.EVENT_MOVE="move",p=r.EVENT_END="end";r.plugins=r.plugins||{},r.gestures=r.gestures||{},r.READY=!1;var d=r.utils={extend:function(e,n,r){for(var i in n)e[i]!==t&&r||(e[i]=n[i]);return e},each:function(e,n,r){var i,s;if("forEach"in e)e.forEach(n,r);else if(e.length!==t){for(i=-1;s=e[++i];)if(n.call(r,s,i,e)===!1)return}else for(i in e)if(e.hasOwnProperty(i)&&n.call(r,e[i],i,e)===!1)return},hasParent:function(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1},getCenter:function(e){var t=[],n=[];return d.each(e,function(e){t.push("undefined"!=typeof e.clientX?e.clientX:e.pageX),n.push("undefined"!=typeof e.clientY?e.clientY:e.pageY)}),{pageX:(Math.min.apply(Math,t)+Math.max.apply(Math,t))/2,pageY:(Math.min.apply(Math,n)+Math.max.apply(Math,n))/2}},getVelocity:function(e,t,n){return{x:Math.abs(t/e)||0,y:Math.abs(n/e)||0}},getAngle:function(e,t){var n=t.pageY-e.pageY,r=t.pageX-e.pageX;return 180*Math.atan2(n,r)/Math.PI},getDirection:function(e,t){var n=Math.abs(e.pageX-t.pageX),r=Math.abs(e.pageY-t.pageY);return n>=r?e.pageX-t.pageX>0?s:u:e.pageY-t.pageY>0?o:i},getDistance:function(e,t){var n=t.pageX-e.pageX,r=t.pageY-e.pageY;return Math.sqrt(n*n+r*r)},getScale:function(e,t){return e.length>=2&&t.length>=2?this.getDistance(t[0],t[1])/this.getDistance(e[0],e[1]):1},getRotation:function(e,t){return e.length>=2&&t.length>=2?this.getAngle(t[1],t[0])-this.getAngle(e[1],e[0]):0},isVertical:function(e){return e==o||e==i},toggleDefaultBehavior:function(e,t,n){if(t&&e&&e.style){d.each(["webkit","moz","Moz","ms","o",""],function(r){d.each(t,function(t,i){r&&(i=r+i.substring(0,1).toUpperCase()+i.substring(1)),i in e.style&&(e.style[i]=!n&&t)})});var r=function(){return!1};"none"==t.userSelect&&(e.onselectstart=!n&&r),"none"==t.userDrag&&(e.ondragstart=!n&&r)}}};r.Instance=function(e,t){var i=this;return n(),this.element=e,this.enabled=!0,this.options=d.extend(d.extend({},r.defaults),t||{}),this.options.stop_browser_behavior&&d.toggleDefaultBehavior(this.element,this.options.stop_browser_behavior,!1),this.eventStartHandler=y.onTouch(e,c,function(e){i.enabled&&w.startDetect(i,e)}),this.eventHandlers=[],this},r.Instance.prototype={on:function(e,t){var n=e.split(" ");return d.each(n,function(e){this.element.addEventListener(e,t,!1),this.eventHandlers.push({gesture:e,handler:t})},this),this},off:function(e,t){var n,r,i=e.split(" ");return d.each(i,function(e){for(this.element.removeEventListener(e,t,!1),n=-1;r=this.eventHandlers[++n];)r.gesture===e&&r.handler===t&&this.eventHandlers.splice(n,1)},this),this},trigger:function(e,t){t||(t={});var n=r.DOCUMENT.createEvent("Event");n.initEvent(e,!0,!0),n.gesture=t;var i=this.element;return d.hasParent(t.target,i)&&(i=t.target),i.dispatchEvent(n),this},enable:function(e){return this.enabled=e,this},dispose:function(){var e,t;for(this.options.stop_browser_behavior&&d.toggleDefaultBehavior(this.element,this.options.stop_browser_behavior,!0),e=-1;t=this.eventHandlers[++e];)this.element.removeEventListener(t.gesture,t.handler,!1);return this.eventHandlers=[],y.unbindDom(this.element,r.EVENT_TYPES[c],this.eventStartHandler),null}};var v=null,m=!1,g=!1,y=r.event={bindDom:function(e,t,n){var r=t.split(" ");d.each(r,function(t){e.addEventListener(t,n,!1)})},unbindDom:function(e,t,n){var r=t.split(" ");d.each(r,function(t){e.removeEventListener(t,n,!1)})},onTouch:function(e,t,n){var i=this,s=function(s){var o=s.type.toLowerCase();if(!o.match(/mouse/)||!g){o.match(/touch/)||o.match(/pointerdown/)||o.match(/mouse/)&&1===s.which?m=!0:o.match(/mouse/)&&!s.which&&(m=!1),o.match(/touch|pointer/)&&(g=!0);var u=0;m&&(r.HAS_POINTEREVENTS&&t!=p?u=b.updatePointer(t,s):o.match(/touch/)?u=s.touches.length:g||(u=o.match(/up/)?0:1),u>0&&t==p?t=h:u||(t=p),(u||null===v)&&(v=s),n.call(w,i.collectEventData(e,t,i.getTouchList(v,t),s)),r.HAS_POINTEREVENTS&&t==p&&(u=b.updatePointer(t,s))),u||(v=null,m=!1,g=!1,b.reset())}};return this.bindDom(e,r.EVENT_TYPES[t],s),s},determineEventTypes:function(){var e;e=r.HAS_POINTEREVENTS?b.getEvents():r.NO_MOUSEEVENTS?["touchstart","touchmove","touchend touchcancel"]:["touchstart mousedown","touchmove mousemove","touchend touchcancel mouseup"],r.EVENT_TYPES[c]=e[0],r.EVENT_TYPES[h]=e[1],r.EVENT_TYPES[p]=e[2]},getTouchList:function(e){return r.HAS_POINTEREVENTS?b.getTouchList():e.touches?e.touches:(e.identifier=1,[e])},collectEventData:function(e,t,n,r){var i=f;return(r.type.match(/mouse/)||b.matchType(a,r))&&(i=a),{center:d.getCenter(n),timeStamp:(new Date).getTime(),target:r.target,touches:n,eventType:t,pointerType:i,srcEvent:r,preventDefault:function(){this.srcEvent.preventManipulation&&this.srcEvent.preventManipulation(),this.srcEvent.preventDefault&&this.srcEvent.preventDefault()},stopPropagation:function(){this.srcEvent.stopPropagation()},stopDetect:function(){return w.stopDetect()}}}},b=r.PointerEvent={pointers:{},getTouchList:function(){var e=[];return d.each(this.pointers,function(t){e.push(t)}),e},updatePointer:function(e,t){return e==p?delete this.pointers[t.pointerId]:(t.identifier=t.pointerId,this.pointers[t.pointerId]=t),Object.keys(this.pointers).length},matchType:function(e,t){if(!t.pointerType)return!1;var n=t.pointerType,r={};return r[a]=n===a,r[f]=n===f,r[l]=n===l,r[e]},getEvents:function(){return["pointerdown MSPointerDown","pointermove MSPointerMove","pointerup pointercancel MSPointerUp MSPointerCancel"]},reset:function(){this.pointers={}}},w=r.detection={gestures:[],current:null,previous:null,stopped:!1,startDetect:function(e,t){this.current||(this.stopped=!1,this.current={inst:e,startEvent:d.extend({},t),lastEvent:!1,lastVelocityEvent:!1,velocity:!1,name:""},this.detect(t))},detect:function(e){if(this.current&&!this.stopped){e=this.extendEventData(e);var t=this.current.inst.options;return d.each(this.gestures,function(n){return this.stopped||t[n.name]===!1||n.handler.call(n,e,this.current.inst)!==!1?void 0:(this.stopDetect(),!1)},this),this.current&&(this.current.lastEvent=e),e.eventType==p&&!e.touches.length-1&&this.stopDetect(),e}},stopDetect:function(){this.previous=d.extend({},this.current),this.current=null,this.stopped=!0},extendEventData:function(e){var t=this.current,n=t.startEvent;(e.touches.length!=n.touches.length||e.touches===n.touches)&&(n.touches=[],d.each(e.touches,function(e){n.touches.push(d.extend({},e))}));var i,s,o=e.timeStamp-n.timeStamp,u=e.center.pageX-n.center.pageX,a=e.center.pageY-n.center.pageY,f=t.lastVelocityEvent,l=t.velocity;return f&&e.timeStamp-f.timeStamp>r.UPDATE_VELOCITY_INTERVAL?(l=d.getVelocity(e.timeStamp-f.timeStamp,e.center.pageX-f.center.pageX,e.center.pageY-f.center.pageY),t.lastVelocityEvent=e,t.velocity=l):t.velocity||(l=d.getVelocity(o,u,a),t.lastVelocityEvent=e,t.velocity=l),e.eventType==p?(i=t.lastEvent&&t.lastEvent.interimAngle,s=t.lastEvent&&t.lastEvent.interimDirection):(i=t.lastEvent&&d.getAngle(t.lastEvent.center,e.center),s=t.lastEvent&&d.getDirection(t.lastEvent.center,e.center)),d.extend(e,{deltaTime:o,deltaX:u,deltaY:a,velocityX:l.x,velocityY:l.y,distance:d.getDistance(n.center,e.center),angle:d.getAngle(n.center,e.center),interimAngle:i,direction:d.getDirection(n.center,e.center),interimDirection:s,scale:d.getScale(n.touches,e.touches),rotation:d.getRotation(n.touches,e.touches),startEvent:n}),e},register:function(e){var n=e.defaults||{};return n[e.name]===t&&(n[e.name]=!0),d.extend(r.defaults,n,!0),e.index=e.index||1e3,this.gestures.push(e),this.gestures.sort(function(e,t){return e.index<t.index?-1:e.index>t.index?1:0}),this.gestures}};r.gestures.Drag={name:"drag",index:50,defaults:{drag_min_distance:10,correct_for_drag_min_distance:!0,drag_max_touches:1,drag_block_horizontal:!1,drag_block_vertical:!1,drag_lock_to_axis:!1,drag_lock_min_distance:25},triggered:!1,handler:function(e,t){if(w.current.name!=this.name&&this.triggered)return t.trigger(this.name+"end",e),void (this.triggered=!1);if(!(t.options.drag_max_touches>0&&e.touches.length>t.options.drag_max_touches))switch(e.eventType){case c:this.triggered=!1;break;case h:if(e.distance<t.options.drag_min_distance&&w.current.name!=this.name)return;if(w.current.name!=this.name&&(w.current.name=this.name,t.options.correct_for_drag_min_distance&&e.distance>0)){var n=Math.abs(t.options.drag_min_distance/e.distance);w.current.startEvent.center.pageX+=e.deltaX*n,w.current.startEvent.center.pageY+=e.deltaY*n,e=w.extendEventData(e)}(w.current.lastEvent.drag_locked_to_axis||t.options.drag_lock_to_axis&&t.options.drag_lock_min_distance<=e.distance)&&(e.drag_locked_to_axis=!0);var r=w.current.lastEvent.direction;e.drag_locked_to_axis&&r!==e.direction&&(e.direction=d.isVertical(r)?e.deltaY<0?o:i:e.deltaX<0?s:u),this.triggered||(t.trigger(this.name+"start",e),this.triggered=!0),t.trigger(this.name,e),t.trigger(this.name+e.direction,e);var a=d.isVertical(e.direction);(t.options.drag_block_vertical&&a||t.options.drag_block_horizontal&&!a)&&e.preventDefault();break;case p:this.triggered&&t.trigger(this.name+"end",e),this.triggered=!1}}},r.gestures.Hold={name:"hold",index:10,defaults:{hold_timeout:500,hold_threshold:1},timer:null,handler:function(e,t){switch(e.eventType){case c:clearTimeout(this.timer),w.current.name=this.name,this.timer=setTimeout(function(){"hold"==w.current.name&&t.trigger("hold",e)},t.options.hold_timeout);break;case h:e.distance>t.options.hold_threshold&&clearTimeout(this.timer);break;case p:clearTimeout(this.timer)}}},r.gestures.Release={name:"release",index:1/0,handler:function(e,t){e.eventType==p&&t.trigger(this.name,e)}},r.gestures.Swipe={name:"swipe",index:40,defaults:{swipe_min_touches:1,swipe_max_touches:1,swipe_velocity:.7},handler:function(e,t){if(e.eventType==p){if(e.touches.length<t.options.swipe_min_touches||e.touches.length>t.options.swipe_max_touches)return;(e.velocityX>t.options.swipe_velocity||e.velocityY>t.options.swipe_velocity)&&(t.trigger(this.name,e),t.trigger(this.name+e.direction,e))}}},r.gestures.Tap={name:"tap",index:100,defaults:{tap_max_touchtime:250,tap_max_distance:10,tap_always:!0,doubletap_distance:20,doubletap_interval:300},has_moved:!1,handler:function(e,t){var n,r,i;e.eventType==c?this.has_moved=!1:e.eventType!=h||this.moved?e.eventType==p&&"touchcancel"!=e.srcEvent.type&&e.deltaTime<t.options.tap_max_touchtime&&!this.has_moved&&(n=w.previous,r=n&&n.lastEvent&&e.timeStamp-n.lastEvent.timeStamp,i=!1,n&&"tap"==n.name&&r&&r<t.options.doubletap_interval&&e.distance<t.options.doubletap_distance&&(t.trigger("doubletap",e),i=!0),(!i||t.options.tap_always)&&(w.current.name="tap",t.trigger(w.current.name,e))):this.has_moved=e.distance>t.options.tap_max_distance}},r.gestures.Touch={name:"touch",index:-1/0,defaults:{prevent_default:!1,prevent_mouseevents:!1},handler:function(e,t){return t.options.prevent_mouseevents&&e.pointerType==a?void e.stopDetect():(t.options.prevent_default&&e.preventDefault(),void (e.eventType==c&&t.trigger(this.name,e)))}},r.gestures.Transform={name:"transform",index:45,defaults:{transform_min_scale:.01,transform_min_rotation:1,transform_always_block:!1,transform_within_instance:!1},triggered:!1,handler:function(e,t){if(w.current.name!=this.name&&this.triggered)return t.trigger(this.name+"end",e),void (this.triggered=!1);if(!(e.touches.length<2)){if(t.options.transform_always_block&&e.preventDefault(),t.options.transform_within_instance)for(var n=-1;e.touches[++n];)if(!d.hasParent(e.touches[n].target,t.element))return;switch(e.eventType){case c:this.triggered=!1;break;case h:var r=Math.abs(1-e.scale),i=Math.abs(e.rotation);if(r<t.options.transform_min_scale&&i<t.options.transform_min_rotation)return;w.current.name=this.name,this.triggered||(t.trigger(this.name+"start",e),this.triggered=!0),t.trigger(this.name,e),i>t.options.transform_min_rotation&&t.trigger("rotate",e),r>t.options.transform_min_scale&&(t.trigger("pinch",e),t.trigger("pinch"+(e.scale<1?"in":"out"),e));break;case p:this.triggered&&t.trigger(this.name+"end",e),this.triggered=!1}}}},"function"==typeof define&&define.amd?define("hammer",[],function(){return r}):"object"==typeof module&&module.exports?module.exports=r:e.Hammer=r}(window),function(e,t){typeof exports=="object"?module.exports=t.call(e):typeof define=="function"&&define.amd?define("physicsjs",[],function(){return t.call(e)}):e.Physics=t.call(e)}(this,function(){var e=this,t=e.document,n=function i(){return i.world.apply(i,arguments)};n.util={},function(e){function t(e,t,n){n=(n||0)-1;for(var r=e?e.length:0;++n<r;)if(e[n]===t)return n;return-1}function r(e,n){var r=typeof n;e=e.l;if("boolean"==r||null==n)return e[n]?0:-1;"number"!=r&&"string"!=r&&(r="object");var i="number"==r?n:P+n;return e=(e=e[r])&&e[i],"object"==r?e&&-1<t(e,n)?0:-1:e?0:-1}function i(e){var t=this.l,n=typeof e;if("boolean"==n||null==e)t[e]=!0;else{"number"!=n&&"string"!=n&&(n="object");var r="number"==n?e:P+e,t=t[n]||(t[n]={});"object"==n?(t[r]||(t[r]=[])).push(e):t[r]=!0}}function s(){return M.pop()||[]}function o(){return _.pop()||{k:null,l:null,"false":!1,"null":!1,number:null,object:null,push:null,string:null,"true":!1,"undefined":!1}}function u(){}function a(e){e.length=0,M.length<B&&M.push(e)}function f(e){var t=e.l;t&&f(t),e.k=e.l=e.object=e.number=e.string=null,_.length<B&&_.push(e)}function l(e,t,n){t||(t=0),typeof n=="undefined"&&(n=e?e.length:0);var r=-1;n=n-t||0;for(var i=Array(0>n?0:n);++r<n;)i[r]=e[t+r];return i}function c(){}function h(e,t,n,r,i){if(n){var o=n(e);if(typeof o!="undefined")return o}if(!b(e))return e;var u=ut.call(e);if(!J[u])return e;var f=yt[u];switch(u){case U:case z:return new f(+e);case W:case $:return new f(e);case V:return o=f(e.source,j.exec(e)),o.lastIndex=e.lastIndex,o}u=Et(e);if(t){var c=!r;r||(r=s()),i||(i=s());for(var p=r.length;p--;)if(r[p]==e)return i[p];o=u?f(e.length):{}}else o=u?l(e):xt({},e);return u&&(it.call(e,"index")&&(o.index=e.index),it.call(e,"input")&&(o.input=e.input)),t?(r.push(e),i.push(o),(u?S:Nt)(e,function(e,s){o[s]=h(e,t,n,r,i)}),c&&(a(r),a(i)),o):o}function p(e,t,n){if(typeof e!="function")return L;if(typeof t=="undefined")return e;var r=e.__bindData__||bt.funcNames&&!e.name;if(typeof r=="undefined"){var i=I&&nt.call(e);bt.funcNames||!i||F.test(i)||(r=!0);if(bt.funcNames||!r)r=!bt.funcDecomp||I.test(i),wt(e,r)}if(!0!==r&&r&&r[1]&1)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)};case 4:return function(n,r,i,s){return e.call(t,n,r,i,s)}}return C(e,t)}function d(e,t,n,r,i,o){if(n){var u=n(e,t);if(typeof u!="undefined")return!!u}if(e===t)return 0!==e||1/e==1/t;if(e===e&&!(e&&G[typeof e]||t&&G[typeof t]))return!1;if(null==e||null==t)return e===t;var f=ut.call(e),l=ut.call(t);f==q&&(f=X),l==q&&(l=X);if(f!=l)return!1;switch(f){case U:case z:return+e==+t;case W:return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case V:case $:return e==String(t)}l=f==R;if(!l){if(it.call(e,"__wrapped__")||it.call(t,"__wrapped__"))return d(e.__wrapped__||e,t.__wrapped__||t,n,r,i,o);if(f!=X)return!1;var f=e.constructor,c=t.constructor;if(f!=c&&!(y(f)&&f instanceof f&&y(c)&&c instanceof c))return!1}c=!i,i||(i=s()),o||(o=s());for(f=i.length;f--;)if(i[f]==e)return o[f]==t;var h=0,u=!0;i.push(e),o.push(t);if(l){f=e.length,h=t.length,u=h==e.length;if(!u&&!r)return u;for(;h--;)if(l=f,c=t[h],r)for(;l--&&!(u=d(e[l],c,n,r,i,o)););else if(!(u=d(e[h],c,n,r,i,o)))break;return u}return Tt(t,function(t,s,a){if(it.call(a,s))return h++,u=it.call(e,s)&&d(e[s],t,n,r,i,o)}),u&&!r&&Tt(e,function(e,t,n){if(it.call(n,t))return u=-1<--h}),c&&(a(i),a(o)),u}function v(e,t,n,r,i,s){var o=t&1,u=t&2,a=t&4,f=t&8,l=t&16,c=t&32,h=e;if(!u&&!y(e))throw new TypeError;l&&!n.length&&(t&=-17,l=n=!1),c&&!r.length&&(t&=-33,c=r=!1);var p=e&&e.__bindData__;if(p)return!o||p[1]&1||(p[4]=i),!o&&p[1]&1&&(t|=8),!a||p[1]&4||(p[5]=s),l&&ot.apply(p[2]||(p[2]=[]),n),c&&ot.apply(p[3]||(p[3]=[]),r),p[1]|=t,v.apply(null,p);if(!o||u||a||c||!(bt.fastBind||lt&&l))g=function(){var p=arguments,d=o?i:this;if(a||l||c)if(p=gt.call(p),l&&at.apply(p,n),c&&ot.apply(p,r),a&&p.length<s)return t|=16,v(e,f?t:t&-4,p,null,i,s);return u&&(e=d[h]),this instanceof g?(d=m(e.prototype),p=e.apply(d,p),b(p)?p:d):e.apply(d,p)};else{if(l){var d=[i];ot.apply(d,n)}var g=l?lt.apply(e,d):lt.call(e,i)}return wt(g,gt.call(arguments)),g}function m(e){return b(e)?ct(e):{}}function g(e){var t,n;return!!e&&ut.call(e)==X&&(t=e.constructor,!y(t)||t instanceof t)?(Tt(e,function(e,t){n=t}),typeof n=="undefined"||it.call(e,n)):!1}function y(e){return typeof e=="function"}function b(e){return!!e&&!!G[typeof e]}function w(e,t,n){var r=[];t=c.createCallback(t,n,3),n=-1;var i=e?e.length:0;if(typeof i=="number")for(;++n<i;){var s=e[n];t(s,n,e)&&r.push(s)}else Nt(e,function(e,n,i){t(e,n,i)&&r.push(e)});return r}function E(e,t,n){t=c.createCallback(t,n,3),n=-1;var r=e?e.length:0;if(typeof r!="number"){var s;return Nt(e,function(e,n,r){if(t(e,n,r))return s=e,!1}),s}for(;++n<r;){var i=e[n];if(t(i,n,e))return i}}function S(e,t,n){var r=-1,i=e?e.length:0;t=t&&typeof n=="undefined"?t:p(t,n,3);if(typeof i=="number")for(;++r<i&&!1!==t(e[r],r,e););else Nt(e,t);return e}function x(e,n,r){if(typeof r=="number"){var i=e?e.length:0;r=0>r?dt(0,i+r):r||0}else if(r)return r=T(e,n),e[r]===n?r:-1;return t(e,n,r)}function T(e,t,n,r){var i=0,s=e?e.length:i;n=n?c.createCallback(n,r,1):L;for(t=n(t);i<s;)r=i+s>>>1,n(e[r])<t?i=r+1:s=r;return i}function N(e,n,u,l){typeof n!="boolean"&&null!=n&&(u=(l=u)&&l[n]===e?null:n,n=!1),null!=u&&(u=c.createCallback(u,l,3)),l=-1;var h;h=(h=c.indexOf)===x?t:h;var p=e?e.length:0,d=[],v=!n&&p>=H&&h===t,m=u||v?s():d;if(v){var g;g=m;var y=-1,b=g.length,w=g[0],E=g[b/2|0],S=g[b-1];if(w&&typeof w=="object"&&E&&typeof E=="object"&&S&&typeof S=="object")g=!1;else{w=o(),w["false"]=w["null"]=w["true"]=w.undefined=!1,E=o(),E.k=g,E.l=w;for(E.push=i;++y<b;)E.push(g[y]);g=E}g?(h=r,m=g):(v=!1,m=u?m:(a(m),d))}for(;++l<p;)if(g=e[l],y=u?u(g,l,e):g,n?!l||m[m.length-1]!==y:0>h(m,y))(u||v)&&m.push(y),d.push(g);return v?(a(m.k),f(m)):u&&a(m),d}function C(e,t){return 2<arguments.length?v(e,17,gt.call(arguments,2),null,t):v(e,1,null,null,t)}function k(e,t,n){var r,i,s,o,u,a,f,l=0,c=!1,h=!0;if(!y(e))throw new TypeError;t=dt(0,t)||0;if(!0===n)var p=!0,h=!1;else b(n)&&(p=n.leading,c="maxWait"in n&&(dt(t,n.maxWait)||0),h="trailing"in n?n.trailing:h);var d=function(){var n=t-(st()-o);0>=n?(i&&clearTimeout(i),n=f,i=a=f=O,n&&(l=st(),s=e.apply(u,r))):a=setTimeout(d,n)},v=function(){a&&clearTimeout(a),i=a=f=O;if(h||c!==t)l=st(),s=e.apply(u,r)};return function(){r=arguments,o=st(),u=this,f=h&&(a||!p);if(!1===c)var n=p&&!a;else{i||p||(l=o);var m=c-(o-l);0>=m?(i&&(i=clearTimeout(i)),l=o,s=e.apply(u,r)):i||(i=setTimeout(v,m))}return a||t===c||(a=setTimeout(d,t)),n&&(s=e.apply(u,r)),s}}function L(e){return e}function A(e,t,n){var r=null==e,i=null==t;return null==n&&(typeof e=="boolean"&&i?(n=e,e=1):i||typeof t!="boolean"||(n=t,i=!0)),r&&i&&(t=1),e=+e||0,i?(t=e,e=0):t=+t||0,r=mt(),n||e%1||t%1?vt(e+r*(t-e+parseFloat("1e-"+((r+"").length-1))),t):e+tt(r*(t-e+1))}var O,M=[],_=[],D=0,P=+(new Date)+"",H=75,B=40,j=/\w*$/,F=/^function[ \n\r\t]+\w/,I=/\bthis\b/,q="[object Arguments]",R="[object Array]",U="[object Boolean]",z="[object Date]",W="[object Number]",X="[object Object]",V="[object RegExp]",$="[object String]",J={"[object Function]":!1};J[q]=J[R]=J[U]=J[z]=J[W]=J[X]=J[V]=J[$]=!0;var K={leading:!1,maxWait:0,trailing:!1},Q={configurable:!1,enumerable:!1,value:null,writable:!1},G={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,"undefined":!1};e=G[typeof e]&&e||this;var Y=[],Z=Object.prototype,et=RegExp("^"+String(Z.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),tt=Math.floor,nt=Function.prototype.toString,rt=et.test(rt=Object.getPrototypeOf)&&rt,it=Z.hasOwnProperty,st=et.test(st=Date.now)&&st||function(){return+(new Date)},ot=Y.push,ut=Z.toString,at=Y.unshift,ft=function(){try{var e={},t=et.test(t=Object.defineProperty)&&t,n=t(e,e,e)&&t}catch(r){}return n}(),lt=et.test(lt=ut.bind)&&lt,ct=et.test(ct=Object.create)&&ct,ht=et.test(ht=Array.isArray)&&ht,pt=et.test(pt=Object.keys)&&pt,dt=Math.max,vt=Math.min,mt=Math.random,gt=Y.slice,Y=et.test(e.attachEvent),Y=lt&&!/\n|true/.test(lt+Y),yt={};yt[R]=Array,yt[U]=Boolean,yt[z]=Date,yt["[object Function]"]=Function,yt[X]=Object,yt[W]=Number,yt[V]=RegExp,yt[$]=String;var bt=c.support={};bt.fastBind=lt&&!Y,bt.funcDecomp=!et.test(e.WinRTError)&&I.test(function(){return this}),bt.funcNames=typeof Function.name=="string",ct||(m=function(e){if(b(e)){u.prototype=e;var t=new u;u.prototype=null}return t||{}});var wt=ft?function(e,t){Q.value=t,ft(e,"__bindData__",Q)}:u,Et=ht||function(e){return e&&typeof e=="object"&&typeof e.length=="number"&&ut.call(e)==R||!1},ht=function(e){var t,n=[];if(!e||!G[typeof e])return n;for(t in e)it.call(e,t)&&n.push(t);return n},St=pt?function(e){return b(e)?pt(e):[]}:ht,xt=function(e,t,n){var r,i=e,s=i;if(!i)return s;var o=arguments,u=0,a=typeof n=="number"?2:o.length;if(3<a&&"function"==typeof o[a-2])var f=p(o[--a-1],o[a--],2);else 2<a&&"function"==typeof o[a-1]&&(f=o[--a]);for(;++u<a;)if((i=o[u])&&G[typeof i])for(var l=-1,c=G[typeof i]&&St(i),h=c?c.length:0;++l<h;)r=c[l],s[r]=f?f(s[r],i[r]):i[r];return s},Tt=function(e,t,n){var r;if(!e||!G[typeof e])return e;t=t&&typeof n=="undefined"?t:p(t,n,3);for(r in e)if(!1===t(e[r],r,e))break;return e},Nt=function(e,t,n){if(!e||!G[typeof e])return e;t=t&&typeof n=="undefined"?t:p(t,n,3);for(var r=-1,i=G[typeof e]&&St(e),s=i?i.length:0;++r<s&&(n=i[r],!1!==t(e[n],n,e)););return e};c.assign=xt,c.bind=C,c.createCallback=function(e,t,n){var r=typeof e;if(null==e||"function"==r)return p(e,t,n);if("object"!=r)return function(t){return t[e]};var i=St(e),s=i[0],o=e[s];return 1!=i.length||o!==o||b(o)?function(t){for(var n=i.length,r=!1;n--&&(r=d(t[i[n]],e[i[n]],null,!0)););return r}:function(e){return e=e[s],o===e&&(0!==o||1/o==1/e)}},c.debounce=k,c.defaults=function(e,t,n){var r,i=e,s=i;if(!i)return s;for(var o=arguments,u=0,a=typeof n=="number"?2:o.length;++u<a;)if((i=o[u])&&G[typeof i])for(var f=-1,l=G[typeof i]&&St(i),c=l?l.length:0;++f<c;)r=l[f],"undefined"==typeof s[r]&&(s[r]=i[r]);return s},c.filter=w,c.forEach=S,c.forIn=Tt,c.forOwn=Nt,c.keys=St,c.shuffle=function(e){var t=-1,n=e?e.length:0,r=Array(typeof n=="number"?n:0);return S(e,function(e){var n=A(++t);r[t]=r[n],r[n]=e}),r},c.throttle=function(e,t,n){var r=!0,i=!0;if(!y(e))throw new TypeError;return!1===n?r=!1:b(n)&&(r="leading"in n?n.leading:r,i="trailing"in n?n.trailing:i),K.leading=r,K.maxWait=t,K.trailing=i,k(e,t,K)},c.transform=function(e,t,n,r){var i=Et(e);return t=p(t,r,4),null==n&&(i?n=[]:(r=e&&e.constructor,n=m(r&&r.prototype))),(i?S:Nt)(e,function(e,r,i){return t(n,e,r,i)}),n},c.uniq=N,c.each=S,c.extend=xt,c.select=w,c.unique=N,c.clone=function(e,t,n,r){return typeof t!="boolean"&&null!=t&&(r=n,n=t,t=!1),h(e,t,typeof n=="function"&&p(n,r,1))},c.find=E,c.identity=L,c.indexOf=x,c.isArray=Et,c.isFunction=y,c.isObject=b,c.isPlainObject=function(e){if(!e||ut.call(e)!=X)return!1;var t=e.valueOf,n=typeof t=="function"&&(n=rt(t))&&rt(n);return n?e==n||rt(e)==n:g(e)},c.random=A,c.sortedIndex=T,c.uniqueId=function(e){var t=++D;return String(null==e?"":e)+t},c.detect=E,c.findWhere=E,c.VERSION="2.2.1",c.extend(n.util,c)}(this);var r=n.util.decorator=function(t,r){var i={},s={},o=function(t,r,i,s){var o=Object.getOwnPropertyDescriptor(s,i);o.get||o.set?Object.defineProperty(t,i,o):n.util.isFunction(o.value)&&(t[i]=o.value)},u=function(t,r){return n.util.transform(r,o,t)},a=Object.getPrototypeOf;typeof a!="function"&&(typeof "test".__proto__=="object"?a=function(e){return e.__proto__}:a=function(e){return e.constructor.prototype});var f=Object.create;typeof f!="function"&&(f=function(e){function t(){}return t.prototype=e,new t});var l=function(r,i){if(typeof r=="object"){s=u(s,r),s.type=t;return}r!=="type"&&n.util.isFunction(i)&&(s[r]=i)};l(r);var c=function(n,r,o,l){var c,h,p=s,d;if(typeof r!="string")l=o,o=r;else{p=i[r];if(!p)throw'Error: "'+r+'" '+t+" not defined";p=p.prototype}if(typeof o=="function")h=i[n],h?h.prototype=u(h.prototype,o(a(h.prototype))):(h=i[n]=function v(e){this.init&&this.init(e)},h.prototype=f(p),h.prototype=u(h.prototype,o(p,h.prototype))),h.prototype.type=t,h.prototype.name=n;else{l=o||{},h=i[n];if(!h)throw'Error: "'+n+'" '+t+" not defined"}if(l)return new h(l)};return c.mixin=l,c};return n.util.indexOf=function(t,n){var r=0,i=t.length;while(r<i){i--;if(t[r]===n)return r;if(t[i]===n)return i;r++}return-1},n.util.options=function(e,t,r){var i={},s,o=[];return s=function(r){n.util.extend(t,r,null);for(var i=0,s=o.length;i<s;++i)o[i](t);return t},s.defaults=function(r){return n.util.extend(i,r),n.util.defaults(t,i),i},s.onChange=function(e){o.push(e)},t=t||s,s.defaults(e),s},function(e){var t=e.Physics;n.noConflict=function(){return e.Physics===n&&(e.Physics=t),n}}(this),function(){var e=function t(){if(!(this instanceof t))return new t};e.prototype={on:function(e,t,r,i){var s,o,u;this._topics=this._topics||(this._topics={});if(n.util.isObject(e)){for(var a in e)this.on(a,e[a],t,r);return this}return s=this._topics[e]||(this._topics[e]=[]),o=t,n.util.isObject(r)?(t=n.util.bind(t,r),t._bindfn_=o,t._one_=o._one_):i||(i=r),t._priority_=i,u=n.util.sortedIndex(s,t,"_priority_"),s.splice(u,0,t),this},off:function(e,t){var r,i;if(!this._topics)return this;if(e===!0)return this._topics={},this;if(n.util.isObject(e)){for(var s in e)this.off(s,e[s]);return this}r=this._topics[e];if(!r)return this;if(t===!0)return this._topics[e]=[],this;for(var o=0,u=r.length;o<u;o++){i=r[o];if(i._bindfn_===t||i===t){r.splice(o,1);break}}return this},emit:function(e,t){if(!this._topics)return this;var n=this._topics[e],r=n&&n.length,i;if(!r)return this;while(r--)i=n[r],i(t,{topic:e,handler:i}),i._one_&&n.splice(r,1);return this},one:function(e,t,r){if(n.util.isObject(e)){for(var i in e)this.one(i,e[i],t,r);return this}return t._one_=!0,this.on(e,t,r),this}},n.util.pubsub=e}(),Date.now||(Date.now=function(){return(new Date).getTime()}),function(){var t=["webkit","moz"];for(var n=0;n<t.length&&!e.requestAnimationFrame;++n){var r=t[n];e.requestAnimationFrame=e[r+"RequestAnimationFrame"],e.cancelAnimationFrame=e[r+"CancelAnimationFrame"]||e[r+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(e.navigator.userAgent)||!e.requestAnimationFrame||!e.cancelAnimationFrame){var i=0;e.requestAnimationFrame=function(e){var t=Date.now(),n=Math.max(i+16,t);return setTimeout(function(){e(i=n)},n-t)},e.cancelAnimationFrame=clearTimeout}}(),function(){var e=100,t=10,r="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",i="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",s="Error: Too many scratchpads created. (Did you forget to call .done()?)",o=[],u=0,a=function(){this.objIndex=0,this.arrayIndex=0,this.vectorIndex=0,this.aabbIndex=0,this.transformIndex=0,this.objectStack=[],this.arrayStack=[],this.vectorStack=[],this.aabbStack=[],this.transformStack=[];if(++u>=e)throw s};a.prototype={done:function(){this._active=!1,this.objIndex=this.arrayIndex=this.vectorIndex=this.aabbIndex=this.transformIndex=0,o.push(this)},object:function(){var e=this.objectStack;if(!this._active)throw r;if(this.objIndex>=t)throw i;return e[this.objIndex++]||e[e.push({})-1]},array:function(){var e=this.arrayStack;if(!this._active)throw r;if(this.arrIndex>=t)throw i;return e[this.arrIndex++]||e[e.push([])-1]},vector:function(){var e=this.vectorStack;if(!this._active)throw r;if(this.vectorIndex>=t)throw i;return e[this.vectorIndex++]||e[e.push(n.vector())-1]},aabb:function(){var e=this.aabbStack;if(!this._active)throw r;if(this.aabbIndex>=t)throw i;return e[this.aabbIndex++]||e[e.push(n.aabb())-1]},transform:function(){var e=this.transformStack;if(!this._active)throw r;if(this.transformIndex>=t)throw i;return e[this.transformIndex++]||e[e.push(n.transform())-1]}},n.scratchpad=function(){var e=o.pop()||new a;return e._active=!0,e}}(),function(e){function s(){return i&&i.now?i.now()+i.timing.navigationStart:Date.now()}function o(n){if(!t)return;e.requestAnimationFrame(o),r.emit("tick",n)}function u(){return t=!0,o(),this}function a(){return t=!1,this}function f(e){return r.on("tick",e),this}function l(e){return r.off("tick",e),this}function c(){return!!t}var t=!1,r=n.util.pubsub(),i=e.performance;n.util.ticker={now:s,start:u,stop:a,on:f,off:l,isActive:c}}(this),function(){var e=function t(e,r,i,s){if(!(this instanceof t))return new t(e,r,i,s);this._pos=n.vector(),this.set(e,r,i,s)};e.prototype.set=function(t,r,i,s){return n.util.isObject(t)?(this._pos.clone(t.pos),this._hw=t.halfWidth,this._hh=t.halfHeight,this):(this._pos.set(.5*(i+t),.5*(s+r)),this._hw=.5*(i-t),this._hh=.5*(s-r),this)},e.prototype.get=function(){var t=this.halfWidth(),n=this.halfHeight();return{pos:this._pos.values(),halfWidth:t,halfHeight:n,x:t,y:n}},e.prototype.halfWidth=function(){return this._hw},e.prototype.halfHeight=function(){return this._hh},e.prototype.contains=function(t){var n=t.x!==undefined?t.x:t.get(0),r=t.y!==undefined?t.y:t.get(1);return n>this._pos.get(0)-this._hw&&n<this._pos.get(0)+this._hw&&r>this._pos.get(1)-this._hh&&r<this._pos.get(1)+this._hh},e.prototype.transform=function(t){var r=this._hw,i=this._hh,s=n.scratchpad(),o=s.vector().set(r,i),u=s.vector().set(r,-i);return this._pos.translate(t),o.rotate(t),u.rotate(t),this._hw=Math.max(Math.abs(o.get(0)),Math.abs(u.get(0))),this._hh=Math.max(Math.abs(o.get(1)),Math.abs(u.get(1))),s.done(),this},e.contains=function(e,t){var n=t.x!==undefined?t.x:t.get(0),r=t.y!==undefined?t.y:t.get(1);return e=e.get?e.get():e,n>e.pos.x-e.halfWidth&&n<e.pos.x+e.halfWidth&&r>e.pos.y-e.halfHeight&&r<e.pos.y+e.halfHeight},n.aabb=e}(),function(){var e=1e-4,t=100,r=function(t,n,r){var i=n.normSq()-n.dot(t),s=n.dot(t)-t.normSq();return i<0?r.clone(n).negate():s>0?r.clone(t).negate():(r.clone(n).vsub(t),r.perp(t.cross(r)>0))},i=function(t){var r=t.length,i=t[r-2],s=t[r-3],o=n.scratchpad(),u=o.vector().clone(i.pt),a=o.vector().clone(s.pt).vsub(u),f,l;if(a.equals(n.vector.zero))return o.done(),{a:i.a,b:i.b};f=-a.dot(u)/a.normSq(),l=1-f;if(l<=0)return o.done(),{a:s.a,b:s.b};if(f<=0)return o.done(),{a:i.a,b:i.b};var c={a:u.clone(i.a).mult(l).vadd(a.clone(s.a).mult(f)).values(),b:u.clone(i.b).mult(l).vadd(a.clone(s.b).mult(f)).values()};return o.done(),c},s=function(o,u,a,f){var l=!1,c=!1,h=!1,p=[],d=1,v=n.scratchpad(),m=v.vector().clone(u||n.vector.axis[0]),g=v.vector(),y=v.vector(),b=v.vector(),w=v.vector(),E,S,x,T,N=0;T=o(m),d=p.push(T),g.clone(T.pt),m.negate();while(++N){g.swap(y),T=o(m),d=p.push(T),g.clone(T.pt),f&&f(p);if(g.equals(n.vector.zero)){l=!0;break}if(!c&&g.dot(m)<=0){if(a)break;c=!0}if(d===2)m=r(g,y,m);else if(c){m.normalize(),T=y.dot(m);if(Math.abs(T-g.dot(m))<e){h=-T;break}y.normSq()<b.clone(p[0].pt).normSq()?p.shift():p.splice(1,1),m=r(b.clone(p[1].pt),w.clone(p[0].pt),m)}else{E=E||v.vector(),S=S||v.vector(),E.clone(y).vsub(g),S.clone(p[0].pt).vsub(g),x=E.cross(S)>0;if(x^g.cross(E)>0)p.shift(),E.perp(!x),m.swap(E);else{if(!(x^S.cross(g)>0)){l=!0;break}p.splice(1,1),S.perp(x),m.swap(E)}}if(N>t)return v.done(),{simplex:p,iterations:N,distance:0,maxIterationsReached:!0}}return v.done(),T={overlap:l,simplex:p,iterations:N},h!==!1&&(T.distance=h,T.closest=i(p)),T};n.gjk=s}(),function(){var e=function t(e,r,i){if(!(this instanceof t))return new t(e,r);this.v=n.vector(),this.o=n.vector();if(e instanceof t){this.clone(e);return}e&&this.setTranslation(e),this.setRotation(r||0,i)};e.prototype.setTranslation=function(e){return this.v.clone(e),this},e.prototype.setRotation=function(e,t){return this.cosA=Math.cos(e),this.sinA=Math.sin(e),t?this.o.clone(t):this.o.zero(),this},e.prototype.clone=function(t){return t?(this.setTranslation(t.v),this.cosA=t.cosA,this.sinA=t.sinA,this.o.clone(t.o),this):new e(this)},n.transform=e}(),function(e){var t=Math.sqrt,r=Math.min,i=Math.max,s=Math.acos,o=Math.atan2,u=Math.PI*2,a=!!e.Float64Array,f=function l(e,t){if(!(this instanceof l))return new l(e,t);a?this._=new Float64Array(5):this._=[],e&&(e.x!==undefined||e._&&e._.length)?this.clone(e):(this.recalc=!0,this.set(e||0,t||0))};f.prototype.set=function(e,t){return this.recalc=!0,this._[0]=e||0,this._[1]=t||0,this},f.prototype.get=function(e){return this._[e]},f.prototype.vadd=function(e){return this.recalc=!0,this._[0]+=e._[0],this._[1]+=e._[1],this},f.prototype.vsub=function(e){return this.recalc=!0,this._[0]-=e._[0],this._[1]-=e._[1],this},f.prototype.add=function(e,t){return this.recalc=!0,this._[0]+=e,this._[1]+=t===undefined?e:t,this},f.prototype.sub=function(e,t){return this.recalc=!0,this._[0]-=e,this._[1]-=t===undefined?e:t,this},f.prototype.mult=function(e){return this.recalc||(this._[4]*=e*e,this._[3]*=e),this._[0]*=e,this._[1]*=e,this},f.prototype.dot=function(e){return this._[0]*e._[0]+this._[1]*e._[1]},f.prototype.cross=function(e){return-this._[0]*e._[1]+this._[1]*e._[0]},f.prototype.proj=function(e){return this.dot(e)/e.norm()},f.prototype.vproj=function(e){var t=this.dot(e)/e.normSq();return this.clone(e).mult(t)},f.prototype.angle=function(e){var t;if(this.equals(f.zero))return e?e.angle():NaN;e&&!e.equals(f.zero)?t=o(this._[1]*e._[0]-this._[0]*e._[1],this._[0]*e._[0]+this._[1]*e._[1]):t=o(this._[1],this._[0]);while(t>Math.PI)t-=u;while(t<-Math.PI)t+=u;return t},f.prototype.angle2=function(e,t){var n=e._[0]-this._[0],r=e._[1]-this._[1],i=t._[0]-this._[0],s=t._[1]-this._[1],a=o(r*i-n*s,n*i+r*s);while(a>Math.PI)a-=u;while(a<-Math.PI)a+=u;return a},f.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=t(this._[4])),this._[3]},f.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=t(this._[4])),this._[4]},f.prototype.dist=function(e){var n,r;return t((n=e._[0]-this._[0])*n+(r=e._[1]-this._[1])*r)},f.prototype.distSq=function(e){var t,n;return(t=e._[0]-this._[0])*t+(n=e._[1]-this._[1])*n},f.prototype.perp=function(e){var t=this._[0];return e?(this._[0]=this._[1],this._[1]=-t):(this._[0]=-this._[1],this._[1]=t),this},f.prototype.normalize=function(){var e=this.norm();return e===0?this:(e=1/e,this._[0]*=e,this._[1]*=e,this._[3]=1,this._[4]=1,this)},f.prototype.transform=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r,this._[1]-=i,this.set(this._[0]*n-this._[1]*t+r+e.v._[0],this._[0]*t+this._[1]*n+i+e.v._[1])},f.prototype.transformInv=function(e){var t=e.sinA,n=e.cosA,r=e.o._[0],i=e.o._[1];return this._[0]-=r+e.v._[0],this._[1]-=i+e.v._[1],this.set(this._[0]*n+this._[1]*t+r,-this._[0]*t+this._[1]*n+i)},f.prototype.rotate=function(e,t){var n,r,i=0,s=0;return typeof e=="number"?(n=Math.sin(e),r=Math.cos(e),t&&(i=(t.x||t._[0])|0,s=(t.y||t._[1])|0)):(n=e.sinA,r=e.cosA,i=e.o._[0],s=e.o._[1]),this._[0]-=i,this._[1]-=s,this.set(this._[0]*r-this._[1]*n+i,this._[0]*n+this._[1]*r+s)},f.prototype.rotateInv=function(e){return this.set((this._[0]-e.o._[0])*e.cosA+(this._[1]-e.o._[1])*e.sinA+e.o._[0],-(this._[0]-e.o._[0])*e.sinA+(this._[1]-e.o._[1])*e.cosA+e.o._[1])},f.prototype.translate=function(e){return this.vadd(e.v)},f.prototype.translateInv=function(e){return this.vsub(e.v)},f.prototype.clone=function(e){return e?e._?(this.recalc=e.recalc,e.recalc||(this._[3]=e._[3],this._[4]=e._[4]),this._[0]=e._[0],this._[1]=e._[1],this):this.set(e.x,e.y):new f(this)},f.prototype.swap=function(e){var t=this._;return this._=e._,e._=t,t=this.recalc,this.recalc=e.recalc,e.recalc=t,this},f.prototype.values=function(){return{x:this._[0],y:this._[1]}},f.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},f.prototype.negate=function(e){return e!==undefined?(this._[e]=-this._[e],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},f.prototype.clamp=function(e,t){return e=e.values?e.values():e,t=t.values?t.values():t,this._[0]=r(i(this._[0],e.x),t.x),this._[1]=r(i(this._[1],e.y),t.y),this.recalc=!0,this},f.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},f.prototype.equals=function(e){return this._[0]===e._[0]&&this._[1]===e._[1]&&this._[2]===e._[2]},f.vadd=function(e,t){return new f(e._[0]+t._[0],e._[1]+t._[1])},f.vsub=function(e,t){return new f(e._[0]-t._[0],e._[1]-t._[1])},f.mult=function(e,t){return new f(t._[0]*e,t._[1]*e)},f.vproj=function(e,t){return f.mult(e.dot(t)/t.normSq(),t)},f.axis=[new f(1,0),new f(0,1)],f.zero=new f(0,0),n.vector=f}(this),function(e){var t=function(){return!0},r=n.util.indexOf,i=function(t,n){return function(e){return t(e[n])}},s=function(t,i){return function(e){e=i?e[i]:e;var s=0,o;if(n.util.isArray(e)){if(n.util.isArray(t)){o=e.length;if(o!==t.length)return!1;while(s<o){o--;if(r(t,e[s])===-1||r(t,e[o])===-1)return!1;s++}return!0}return r(e,t)>-1}return e===t}},o=function(t,n){var r=s(t,n);return function(e){return!r(e)}},u=function(t,i){return function(e){e=i?e[i]:e;var s=0,o;if(n.util.isArray(e)){o=e.length;while(s<o){o--;if(r(t,e[s])>-1||r(t,e[o])>-1)return!0;s++}return!1}return r(t,e)>-1}},a=function(t,n){var r=u(t,n);return function(e){return!r(e)}},f=function(t){return t=n.vector(t),function(e){var r=e.aabb();return n.aabb.contains(r,t)}},l=function(t){return t.next?function(e){var n=t;while(n){if(!n(e))return!1;n=n.next}return!0}:t},c=function(t){return t.next?function(e){var n=t;while(n){if(n(e))return!0;n=n.next}return!1}:t},h={$eq:s,$ne:o,$in:u,$nin:a,$at:f},p=function d(e,r){var o,u,a,f,p,v;if(r){if(r==="$or"||r==="$and"){for(o=0,u=e.length;o<u;++o)v=d(e[o]),p=p?p.next=v:f=v;return r==="$or"?c(f):l(f)}if(o=h[r])return o(e);throw"Unknown query operation: "+r}for(o in e)a=e[o],o[0]==="$"?v=d(a,o):n.util.isPlainObject(a)?v=i(d(a),o):v=s(a,o),p=p?p.next=v:f=v;return l(f||t)};n.query=p}(this),function(){var e={priority:0};n.behavior=r("behavior",{init:function(t){this.options=n.util.options(e),this.options(t)},applyTo:function(e){return e===!0?this._targets=null:this._targets=n.util.uniq(e),this},getTargets:function(){return this._targets||(this._world?this._world._bodies:[])},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},connect:function(e){this.behave&&e.on("integrate:positions",this.behave,this,this.options.priority)},disconnect:function(e){this.behave&&e.off("integrate:positions",this.behave)},behave:null})}(),function(){var e={hidden:!1,treatment:"dynamic",mass:1,restitution:1,cof:.8,view:null};n.body=r("body",{init:function(t){var r=n.vector;this.options=n.util.options(e,this),this.options(t),this.state={pos:r(this.x,this.y),vel:r(this.vx,this.vy),acc:r(),angular:{pos:this.angle||0,vel:this.angularVelocity||0,acc:0},old:{pos:r(),vel:r(),acc:r(),angular:{pos:0,vel:0,acc:0}}},delete this.x,delete this.y,delete this.vx,delete this.vy,delete this.angle,delete this.angularVelocity;if(this.mass===0)throw"Error: Bodies must have non-zero mass";this.geometry=n.geometry("point")},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},accelerate:function(e){return this.treatment==="dynamic"&&this.state.acc.vadd(e),this},applyForce:function(e,t){if(this.treatment!=="dynamic")return this;var r=n.scratchpad(),i=r.vector(),s;return t?this.moi&&(s=this.state,i.clone(t),this.state.angular.acc-=i.cross(e)/this.moi,this.applyForce(e)):this.accelerate(i.clone(e).mult(1/this.mass)),r.done(),this},aabb:function(){var e=n.scratchpad(),t=e.transform(),r=this.state.angular.pos,i=e.aabb().set(this.geometry.aabb(r));return t.setRotation(0).setTranslation(this.state.pos),i.transform(t),i=i.get(),e.done(),i},recalc:function(){}})}(),function(){n.geometry=r("geometry",{init:function(e){this._aabb=new n.aabb},aabb:function(e){return this._aabb.get()},getFarthestHullPoint:function(e,t){return t=t||n.vector(),t.set(0,0)},getFarthestCorePoint:function(e,t,r){return t=t||n.vector(),t.set(0,0)}})}(),n.geometry.isPolygonConvex=function(e){var t=n.scratchpad(),r=t.vector(),i=t.vector(),s=t.vector(),o=!0,u=!1,a=e.length;if(!e||!a)return!1;if(a<3)return t.done(),o;r.clone(e[0]).vsub(s.clone(e[a-1]));for(var f=1;f<=a;++f){i.clone(e[f%a]).vsub(s.clone(e[(f-1)%a]));if(u===!1)u=r.cross(i);else if(u>0^r.cross(i)>0){o=!1;break}i.swap(r)}return t.done(),o},n.geometry.getPolygonMOI=function(e){var t=n.scratchpad(),r=t.vector(),i=t.vector(),s=0,o=0,u,a=e.length;if(a<2)return t.done(),0;if(a===2)return u=i.clone(e[1]).distSq(r.clone(e[0])),t.done(),u/12;r.clone(e[0]);for(var f=1;f<a;++f)i.clone(e[f]),u=Math.abs(i.cross(r)),s+=u*(i.normSq()+i.dot(r)+r.normSq()),o+=u,r.swap(i);return t.done(),s/(6*o)},n.geometry.isPointInPolygon=function(e,t){var r=n.scratchpad(),i=r.vector().clone(e),s=r.vector(),o=r.vector(),u=0,a=t.length;if(a<2)return u=i.equals(s.clone(t[0])),r.done(),u;if(a===2)return u=i.angle(s.clone(t[0])),u+=i.angle(s.clone(t[1])),r.done(),Math.abs(u)===Math.PI;s.clone(t[0]).vsub(i);for(var f=1;f<=a;++f)o.clone(t[f%a]).vsub(i),u+=o.angle(s),s.swap(o);return r.done(),Math.abs(u)>1e-6},n.geometry.getPolygonArea=function(t){var r=n.scratchpad(),i=r.vector(),s=r.vector(),o=0,u=t.length;if(u<3)return r.done(),0;i.clone(t[u-1]);for(var a=0;a<u;++a)s.clone(t[a]),o+=i.cross(s),i.swap(s);return r.done(),o/2},n.geometry.getPolygonCentroid=function(t){var r=n.scratchpad(),i=r.vector(),s=r.vector(),o=n.vector(),u,a=t.length;if(a<2)return r.done(),n.vector(t[0]);if(a===2)return r.done(),n.vector((t[1].x+t[0].x)/2,(t[1].y+t[0].y)/2);i.clone(t[a-1]);for(var f=0;f<a;++f)s.clone(t[f]),u=i.cross(s),i.vadd(s).mult(u),o.vadd(i),i.swap(s);return u=1/(6*n.geometry.getPolygonArea(t)),r.done(),o.mult(u)},n.geometry.nearestPointOnLine=function(t,r,i){var s=n.scratchpad(),o=s.vector().clone(t),u=s.vector().clone(r).vsub(o),a=s.vector().clone(i).vsub(o).vsub(u),f,l;return a.equals(n.vector.zero)?(s.done(),n.vector(r)):(f=-a.dot(u)/a.normSq(),l=1-f,l<=0?(s.done(),n.vector(i)):f<=0?(s.done(),n.vector(r)):(o=n.vector(i).mult(f).vadd(u.clone(r).mult(l)),s.done(),o))},function(){var e={drag:0};n.integrator=r("integrator",{init:function(t){this.options=n.util.options(e)},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},integrate:function(e,t){var n=this._world;return this.integrateVelocities(e,t),n&&n.emit("integrate:velocities",{bodies:e,dt:t}),this.integratePositions(e,t),n&&n.emit("integrate:positions",{bodies:e,dt:t}),this},integrateVelocities:function(e,t){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(e,t){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var e={meta:!1,metaRefresh:200,width:600,height:600};n.renderer=r("renderer",{init:function(r){var i=typeof r.el=="string"?t.getElementById(r.el):r.el;this.options=n.util.extend({},e,r),this.el=i?i:t.body,this.drawMeta=n.util.throttle(n.util.bind(this.drawMeta,this),this.options.metaRefresh)},setWorld:function(e){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=e,this.connect&&e&&this.connect(e),this},render:function(e,t){var n,r,i;this.beforeRender&&this.beforeRender(),this._world.emit("beforeRender",{renderer:this,bodies:e,meta:t}),this.options.meta&&this.drawMeta(t);for(var s=0,o=e.length;s<o;++s)n=e[s],r=n.view||(n.view=this.createView(n.geometry,n.styles)),n.hidden||this.drawBody(n,r);return this},createView:function(e){throw"You must override the renderer.createView() method."},drawMeta:function(e){throw"You must override the renderer.drawMeta() method."},drawBody:function(e,t){throw"You must override the renderer.drawBody() method."}})}(),function(){var e=function i(e,t,n){var r,s,o=function(){return i(e,t,n)};while(r=e.shift()){s=r.apply(t,n);if(s&&s.then)return s.then(o)}},t={timestep:6.25,maxIPF:16,webworker:!1,integrator:"verlet"},r=function s(e,t){if(!(this instanceof s))return new s(e,t);this.init(e,t)};r.prototype=n.util.extend({},n.util.pubsub.prototype,{init:function(r,i){var s=this;if(n.util.isFunction(r)||n.util.isArray(r))i=r,r={};this._stats={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this.options=n.util.options(t),this.options.onChange(function(e){s.timeStep(e.timestep)}),this.options(r),this.add(n.integrator(this.options.integrator)),n.util.isFunction(i)?e([i],this,[this,n]):n.util.isArray(i)&&e(i,this,[this,n])},options:null,add:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e;if(!r)return this;do switch(r.type){case"behavior":this.addBehavior(r);break;case"integrator":this.integrator(r);break;case"renderer":this.renderer(r);break;case"body":this.addBody(r);break;default:throw'Error: failed to add item of unknown type "'+r.type+'" to world'}while(++t<n&&(r=e[t]));return this},remove:function(e){var t=0,n=e&&e.length||0,r=n?e[0]:e;if(!r)return this;do switch(r.type){case"behavior":this.removeBehavior(r);break;case"integrator":r===this._integrator&&this.integrator(null);break;case"renderer":r===this._renderer&&this.renderer(null);break;case"body":this.removeBody(r);break;default:throw'Error: failed to remove item of unknown type "'+r.type+'" from world'}while(++t<n&&(r=e[t]));return this},has:function(e){var t,r,i;if(!e)return!1;switch(e.type){case"behavior":t=this._behaviors;break;case"integrator":return this._integrator===e;case"renderer":return this._renderer===e;case"body":t=this._bodies;break;default:throw'Error: unknown type "'+e.type+'"'}return n.util.indexOf(t,e)>-1},integrator:function(e){return e===undefined?this._integrator:this._integrator===e?this:(this._integrator&&(this._integrator.setWorld(null),this.emit("remove:integrator",{integrator:this._integrator})),e&&(this._integrator=e,this._integrator.setWorld(this),this.emit("add:integrator",{integrator:this._integrator})),this)},renderer:function(e){return e===undefined?this._renderer:this._renderer===e?this:(this._renderer&&(this._renderer.setWorld(null),this.emit("remove:renderer",{renderer:this._renderer})),e&&(this._renderer=e,this._renderer.setWorld(this),this.emit("add:renderer",{renderer:this._renderer})),this)},timeStep:function(e){return e?(this._dt=e,this._maxJump=e*this.options.maxIPF,this):this._dt},addBehavior:function(e){var t;return this.has(e)?this:(e.setWorld(this),this._behaviors.push(e),this.emit("add:behavior",{behavior:e}),this)},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(e){var t=this._behaviors;if(e)for(var n=0,r=t.length;n<r;++n)if(e===t[n]){t.splice(n,1),e.setWorld(null),this.emit("remove:behavior",{behavior:e});break}return this},addBody:function(e){var t;return this.has(e)?this:(e.setWorld(this),this._bodies.push(e),this.emit("add:body",{body:e}),this)},getBodies:function(){return[].concat(this._bodies)},removeBody:function(e){var t=this._bodies;if(e)for(var n=0,r=t.length;n<r;++n)if(e===t[n]){t.splice(n,1),e.setWorld(null),this.emit("remove:body",{body:e});break}return this},findOne:function(e){var t=this,r=typeof e=="function"?e:n.query(e);return n.util.find(t._bodies,r)||!1},find:function(e){var t=this,r=typeof e=="function"?e:n.query(e);return n.util.filter(t._bodies,r)},iterate:function(e){this._integrator.integrate(this._bodies,e)},step:function(e){if(this._paused)return this._time=!1,this;var t=this._time||(this._time=e),n=e-t,r=this._stats,i=this._dt;if(!n)return this;n>this._maxJump&&(this._time=e-this._maxJump,n=this._maxJump),r.fps=1e3/n,r.ipf=Math.ceil(n/this._dt);while(this._time<e)this._time+=i,this.iterate(i);return this.emit("step"),this},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._stats),this.emit("render",{bodies:this._bodies,stats:this._stats,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.emit("pause"),this},unpause:function(){return this._paused=!1,this.emit("unpause"),this},isPaused:function(){return!!this._paused},destroy:function(){var e=this;e.pause(),this.emit("destroy"),e.off(!0),e.remove(e.getBodies()),e.remove(e.getBehaviors()),e.integrator(null),e.renderer(null)}}),n.world=r}(),n.integrator("verlet",function(e){return n.body.mixin({started:function(e){return e!==undefined&&(this._started=!0),!!this._started}}),{init:function(t){e.init.call(this,t)},integrateVelocities:function(e,t){var n=t*t,r=1-this.options.drag,i=null,s;for(var o=0,u=e.length;o<u;++o)i=e[o],s=i.state,i.treatment!=="static"?(s.vel.equals(s.old.vel)&&i.started()?s.vel.clone(s.pos).vsub(s.old.pos):(s.old.pos.clone(s.pos).vsub(s.vel),s.vel.mult(t)),r&&s.vel.mult(r),s.vel.vadd(s.acc.mult(n)),s.vel.mult(1/t),s.old.vel.clone(s.vel),s.acc.zero(),s.angular.vel===s.old.angular.vel&&i.started()?s.angular.vel=s.angular.pos-s.old.angular.pos:(s.old.angular.pos=s.angular.pos-s.angular.vel,s.angular.vel*=t),s.angular.vel+=s.angular.acc*n,s.angular.vel/=t,s.old.angular.vel=s.angular.vel,s.angular.acc=0,i.started(!0)):(s.vel.zero(),s.acc.zero(),s.angular.vel=0,s.angular.acc=0)},integratePositions:function(e,t){var n=t*t,r=null,i;for(var s=0,o=e.length;s<o;++s)r=e[s],i=r.state,r.treatment!=="static"&&(i.vel.mult(t),i.old.pos.clone(i.pos),i.pos.vadd(i.vel),i.vel.mult(1/t),i.old.vel.clone(i.vel),i.angular.vel*=t,i.old.angular.pos=i.angular.pos,i.angular.pos+=i.angular.vel,i.angular.vel/=t,i.old.angular.vel=i.angular.vel)}}}),n.geometry("point",function(e){}),n.geometry("circle",function(e){var t={radius:1};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.radius=r.radius,this._aabb=n.aabb()},aabb:function(e){var t=this.radius,n=this._aabb;return n.halfWidth()===t?n.get():n.set(-t,-t,t,t).get()},getFarthestHullPoint:function(e,t){return t=t||n.vector(),t.clone(e).normalize().mult(this.radius)},getFarthestCorePoint:function(e,t,r){return t=t||n.vector(),t.clone(e).normalize().mult(this.radius-r)}}}),n.geometry("convex-polygon",function(e){var t="Error: The vertices specified do not match that of a _convex_ polygon.",r={};return{init:function(t){e.init.call(this,t),t=n.util.extend({},r,t),this.setVertices(t.vertices||[])},setVertices:function(e){var r=n.scratchpad(),i=r.transform(),s=this.vertices=[];if(!n.geometry.isPolygonConvex(e))throw t;i.setRotation(0),i.setTranslation(n.geometry.getPolygonCentroid(e).negate());for(var o=0,u=e.length;o<u;++o)s.push(n.vector(e[o]).translate(i));return this._area=n.geometry.getPolygonArea(s),this._aabb=!1,r.done(),this},aabb:function(e){if(!e&&this._aabb)return this._aabb.get();var t=n.scratchpad(),r=t.vector(),i=t.transform().setRotation(e||0),s=t.vector().clone(n.vector.axis[0]).rotateInv(i),o=t.vector().clone(n.vector.axis[1]).rotateInv(i),u=this.getFarthestHullPoint(s,r).proj(s),a=-this.getFarthestHullPoint(s.negate(),r).proj(s),f=this.getFarthestHullPoint(o,r).proj(o),l=-this.getFarthestHullPoint(o.negate(),r).proj(o),c;return c=new n.aabb(a,l,u,f),e||(this._aabb=c),t.done(),c.get()},getFarthestHullPoint:function(e,t,r){var i=this.vertices,s,o,u=i.length,a=2,f;t=t||n.vector();if(u<2)return r&&(r.idx=0),t.clone(i[0]);o=i[0].dot(e),s=i[1].dot(e);if(u===2)return f=s>=o?1:0,r&&(r.idx=f),t.clone(i[f]);if(s>=o){while(a<u&&s>=o)o=s,s=i[a].dot(e),a++;return s>=o&&a++,f=a-2,r&&(r.idx=a-2),t.clone(i[f])}a=u;while(a>1&&o>=s)a--,s=o,o=i[a].dot(e);return f=(a+1)%u,r&&(r.idx=f),t.clone(i[f])},getFarthestCorePoint:function(e,t,r){var i,s=n.scratchpad(),o=s.vector(),u=s.vector(),a=this.vertices,f=a.length,l,c=this._area>0,h={};return t=this.getFarthestHullPoint(e,t,h),o.clone(a[(h.idx+1)%f]).vsub(t).normalize().perp(c),u.clone(a[(h.idx-1+f)%f]).vsub(t).normalize().perp(!c),l=r/(1+o.dot(u)),t.vadd(o.vadd(u).mult(l)),s.done(),t}}}),n.body("circle",function(e){var t={radius:1};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.geometry=n.geometry("circle",{radius:r.radius}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}}),n.body("convex-polygon",function(e){var t={};return{init:function(r){e.init.call(this,r),r=n.util.extend({},t,r),this.geometry=n.geometry("convex-polygon",{vertices:r.vertices}),this.recalc()},recalc:function(){e.recalc.call(this),this.moi=n.geometry.getPolygonMOI(this.geometry.vertices)}}}),n.body("point",function(){}),n.behavior("attractor",function(e){var t={pos:null,strength:1,order:2,max:!1,min:!1};return{init:function(r){var i=this;this._pos=new n.vector,e.init.call(this),this.options.defaults(t),this.options.onChange(function(e){i._maxDist=e.max===!1?Infinity:e.max,i._minDist=e.min?e.min:10,i.position(e.pos)}),this.options(r)},position:function(e){var t=this;return e?(this._pos.clone(e),t):this._pos.values()},behave:function(e){var t=this.getTargets(),r,i=this.options.order,s=this.options.strength,o=this._minDist,u=this._maxDist,a=n.scratchpad(),f=a.vector(),l,c;for(var h=0,p=t.length;h<p;h++)r=t[h],f.clone(this._pos),f.vsub(r.state.pos),l=f.norm(),l>o&&l<u&&(c=s/Math.pow(l,i),r.accelerate(f.normalize().mult(c)));a.done()}}}),n.behavior("body-collision-detection",function(e){var t=function(t,r){var i;return i=function(e){var s=n.scratchpad(),o=s.transform().setTranslation(t.state.pos).setRotation(t.state.angular.pos),u=s.transform().setTranslation(r.state.pos).setRotation(r.state.angular.pos),a=s.vector(),f=s.vector(),l=i.useCore?"getFarthestCorePoint":"getFarthestHullPoint",c=i.marginA,h=i.marginB,p;return a=t.geometry[l](e.rotateInv(o),a,c).transform(o),f=r.geometry[l](e.rotate(o).rotateInv(u).negate(),f,h).transform(u),e.negate().rotate(u),p={a:a.values(),b:f.values(),pt:a.vsub(f).values()},s.done(),p},i.useCore=!1,i.margin=0,i},r=function(r,i){var s=n.scratchpad(),o=s.vector(),u=s.vector(),a,f,l,c=!1,h=r.aabb(),p=Math.min(h.halfWidth,h.halfHeight),d=i.aabb(),v=Math.min(d.halfWidth,d.halfHeight);l=t(r,i),o.clone(r.state.pos).vsub(i.state.pos),f=n.gjk(l,o,!0);if(f.overlap){c={bodyA:r,bodyB:i},l.useCore=!0,l.marginA=0,l.marginB=0;while(f.overlap&&(l.marginA<p||l.marginB<v))l.marginA<p&&(l.marginA+=1),l.marginB<v&&(l.marginB+=1),f=n.gjk(l,o);if(f.overlap||f.maxIterationsReached)return s.done(),!1;a=Math.max(0,l.marginA+l.marginB-f.distance),c.overlap=a,c.norm=o.clone(f.closest.b).vsub(u.clone(f.closest.a)).normalize().values(),c.mtv=o.mult(a).values(),c.pos=o.clone(c.norm).mult(l.margin).vadd(u.clone(f.closest.a)).vsub(r.state.pos).values()}return s.done(),c},i=function(t,r){var i=n.scratchpad(),s=i.vector(),o=i.vector(),u,a=!1;return s.clone(r.state.pos).vsub(t.state.pos),u=s.norm()-(t.geometry.radius+r.geometry.radius),s.equals(n.vector.zero)&&s.set(1,0),u<=0&&(a={bodyA:t,bodyB:r,norm:s.normalize().values(),mtv:s.mult(-u).values(),pos:s.normalize().mult(t.geometry.radius).values(),overlap:-u}),i.done(),a},s=function(t,n){return t.treatment!=="static"&&t.treatment!=="kinematic"||n.treatment!=="static"&&n.treatment!=="kinematic"?t.geometry.name==="circle"&&n.geometry.name==="circle"?i(t,n):r(t,n):!1},o={check:"collisions:candidates",channel:"collisions:detected"};return{init:function(t){e.init.call(this),this.options.defaults(o),this.options(t)},connect:function(e){this.options.check===!0?e.on("integrate:velocities",this.checkAll,this):e.on(this.options.check,this.check,this)},disconnect:function(e){this.options.check===!0?e.off("integrate:velocities",this.checkAll):e.off(this.options.check,this.check)},check:function(e){var t=e.candidates,r,i=this.getTargets(),o=[],u;for(var a=0,f=t.length;a<f;++a){r=t[a];if(i===this._world._bodies||n.util.indexOf(i,r.bodyA)>-1&&n.util.indexOf(i,r.bodyB)>-1)u=s(r.bodyA,r.bodyB),u&&o.push(u)}o.length&&this._world.emit(this.options.channel,{collisions:o})},checkAll:function(e){var t=this.getTargets(),n=e.dt,r,i,o=[],u;for(var a=0,f=t.length;a<f;a++){r=t[a];for(var l=a+1;l<f;l++)i=t[l],u=s(r,i),u&&o.push(u)}o.length&&this._world.emit(this.options.channel,{collisions:o})}}}),n.behavior("body-impulse-response",function(e){var t={check:"collisions:detected"};return{init:function(n){e.init.call(this),this.options.defaults(t),this.options(n)},applyTo:!1,connect:function(e){e.on(this.options.check,this.respond,this)},disconnect:function(e){e.off(this.options.check,this.respond)},collideBodies:function(e,t,r,i,s,o){var u=e.treatment==="static"||e.treatment==="kinematic",a=t.treatment==="static"||t.treatment==="kinematic",f=n.scratchpad(),l=f.vector().clone(s);if(u&&a){f.done();return}u?t.state.pos.vadd(l):a?e.state.pos.vsub(l):(l.mult(.5),e.state.pos.vsub(l),t.state.pos.vadd(l));var c=u?0:1/e.moi,h=a?0:1/t.moi,p=u?0:1/e.mass,d=a?0:1/t.mass,v=o?0:e.restitution*t.restitution,m=e.cof*t.cof,g=f.vector().clone(r),y=f.vector().clone(g).perp(),b=f.vector().clone(i),w=f.vector().clone(i).vadd(e.state.pos).vsub(t.state.pos),E=f.vector(),S=e.state.angular.vel,x=t.state.angular.vel,T=f.vector().clone(t.state.vel).vadd(E.clone(w).perp().mult(x)).vsub(e.state.vel).vsub(E.clone(b).perp().mult(S)),N=b.proj(g),C=b.proj(y),k=w.proj(g),L=w.proj(y),A=T.proj(g),O=T.proj(y),M,_,D,P=!1;if(A>=0){f.done();return}M=-((1+v)*A)/(p+d+c*C*C+h*L*L),u?(t.state.vel.vadd(g.mult(M*d)),t.state.angular.vel-=M*h*L):a?(e.state.vel.vsub(g.mult(M*p)),e.state.angular.vel+=M*c*C):(t.state.vel.vadd(g.mult(M*d)),t.state.angular.vel-=M*h*L,e.state.vel.vsub(g.mult(p*t.mass)),e.state.angular.vel+=M*c*C),m&&O&&(D=O/(p+d+c*N*N+h*k*k),P?M=D:(_=O<0?-1:1,M*=_*m,M=_===1?Math.min(M,D):Math.max(M,D)),u?(t.state.vel.vsub(y.mult(M*d)),t.state.angular.vel-=M*h*k):a?(e.state.vel.vadd(y.mult(M*p)),e.state.angular.vel+=M*c*N):(t.state.vel.vsub(y.mult(M*d)),t.state.angular.vel-=M*h*k,e.state.vel.vadd(y.mult(p*t.mass)),e.state.angular.vel+=M*c*N)),f.done()},respond:function(e){var t=this,r,i=n.util.shuffle(e.collisions);for(var s=0,o=i.length;s<o;++s)r=i[s],t.collideBodies(r.bodyA,r.bodyB,r.norm,r.pos,r.mtv)}}}),n.behavior("constant-acceleration",function(e){var t={acc:{x:0,y:4e-4}};return{init:function(r){e.init.call(this),this.options.defaults(t),this.options(r),this._acc=n.vector(),this.setAcceleration(this.options.acc),delete this.options.acc},setAcceleration:function(e){return this._acc.clone(e),this},behave:function(e){var t=this.getTargets();for(var n=0,r=t.length;n<r;++n)t[n].accelerate(this._acc)}}}),n.behavior("edge-collision-detection",function(e){var t=function(t,r,i){var s,o=t.aabb(),u=n.scratchpad(),a=u.transform(),f=u.vector(),l=u.vector(),c=!1,h=[];return s=o.pos.x+o.x-r.max.x,s>=0&&(f.set(1,0).rotateInv(a.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:i,overlap:s,norm:{x:1,y:0},mtv:{x:s,y:0},pos:t.geometry.getFarthestHullPoint(f,l).rotate(a).values()},h.push(c)),s=o.pos.y+o.y-r.max.y,s>=0&&(f.set(0,1).rotateInv(a.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:i,overlap:s,norm:{x:0,y:1},mtv:{x:0,y:s},pos:t.geometry.getFarthestHullPoint(f,l).rotate(a).values()},h.push(c)),s=r.min.x-(o.pos.x-o.x),s>=0&&(f.set(-1,0).rotateInv(a.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:i,overlap:s,norm:{x:-1,y:0},mtv:{x:-s,y:0},pos:t.geometry.getFarthestHullPoint(f,l).rotate(a).values()},h.push(c)),s=r.min.y-(o.pos.y-o.y),s>=0&&(f.set(0,-1).rotateInv(a.setRotation(t.state.angular.pos)),c={bodyA:t,bodyB:i,overlap:s,norm:{x:0,y:-1},mtv:{x:0,y:-s},pos:t.geometry.getFarthestHullPoint(f,l).rotate(a).values()},h.push(c)),u.done(),h},r=function(n,r,i){return t(n,r,i)},i={aabb:null,restitution:.99,cof:1,channel:"collisions:detected"};return{init:function(t){e.init.call(this),this.options.defaults(i),this.options(t),this.setAABB(this.options.aabb),this.restitution=this.options.restitution,this.body=n.body("point",{treatment:"static",restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(e){if(!e)throw"Error: aabb not set";e=e.get&&e.get()||e,this._edges={min:{x:e.pos.x-e.x,y:e.pos.y-e.y},max:{x:e.pos.x+e.x,y:e.pos.y+e.y}}},connect:function(e){e.on("integrate:velocities",this.checkAll,this)},disconnect:function(e){e.off("integrate:velocities",this.checkAll)},checkAll:function(e){var t=this.getTargets(),n=e.dt,i,s=[],o,u=this._edges,a=this.body;for(var f=0,l=t.length;f<l;f++)i=t[f],i.treatment==="dynamic"&&(o=r(i,u,a),o&&s.push.apply(s,o));s.length&&this._world.emit(this.options.channel,{collisions:s})}}}),n.behavior("interactive",function(e){if(!t)return{};var r={el:null,moveThrottle:10,minVel:{x:-5,y:-5},maxVel:{x:5,y:5}},i=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(e=e.offsetParent);return{left:t,top:n}},s=function(e){var t=i(e.target),n=e.changedTouches&&e.changedTouches[0]||e,r=n.pageX-t.left,s=n.pageY-t.top;return{x:r,y:s}};return{init:function(i){var o=this,u,a;e.init.call(this),this.options.defaults(r),this.options(i),this.mousePos=new n.vector,this.mousePosOld=new n.vector,this.offset=new n.vector,this.el=typeof this.options.el=="string"?t.getElementById(this.options.el):this.options.el;if(!this.el)throw"No DOM element specified";var f=function(t){var r=s(t),i;o._world&&(i=o._world.findOne({$at:new n.vector(r.x,r.y)}),i?(u=i.treatment,i.treatment="kinematic",i.state.vel.zero(),i.state.angular.vel=0,o.body=i,o.mousePos.clone(r),o.offset.clone(r).vsub(i.state.pos),r.body=i,o._world.emit("interact:grab",r)):o._world.emit("interact:poke",r))},l=n.util.throttle(function(t){var n,r;o.body&&(n=s(t),a=Date.now(),o.mousePosOld.clone(o.mousePos),o.mousePos.set(n.x,n.y))},o.options.moveThrottle),c=function(t){var n=s(t),r,i=Math.max(Date.now()-a,o.options.moveThrottle);o.mousePos.set(n.x,n.y),o.body&&(o.body.treatment=u,o.body.state.vel.clone(o.mousePos).vsub(o.mousePosOld).mult(1/i),o.body.state.vel.clamp(o.options.minVel,o.options.maxVel),o.body=!1),o._world&&o._world.emit("interact:release",n)};this.el.addEventListener("mousedown",f),this.el.addEventListener("touchstart",f),this.el.addEventListener("mousemove",l),this.el.addEventListener("touchmove",l),this.el.addEventListener("mouseup",c),this.el.addEventListener("touchend",c)},connect:function(e){e.on("integrate:positions",this.behave,this)},disconnect:function(e){e.off("integrate:positions",this.behave)},behave:function(e){var t=this,n;t.body&&(n=t.body.state,n.vel.clone(t.mousePos).vsub(t.offset).vsub(n.pos).mult(1/t.options.moveThrottle))}}}),n.behavior("newtonian",function(e){var t={strength:1,max:!1,min:!1};return{init:function(n){var r=this;e.init.call(this),this.options.defaults(t),this.options.onChange(function(e){r._maxDistSq=e.max===!1?Infinity:e.max*e.max,r._minDistSq=e.min?e.min*e.min:100*e.strength}),this.options(n)},behave:function(e){var t=this.getTargets(),r,i,s=this.options.strength,o=this._minDistSq,u=this._maxDistSq,a=n.scratchpad(),f=a.vector(),l,c;for(var h=0,p=t.length;h<p;h++){r=t[h];for(var d=h+1;d<p;d++)i=t[d],f.clone(i.state.pos),f.vsub(r.state.pos),l=f.normSq(),l>o&&l<u&&(c=s/l,r.accelerate(f.normalize().mult(c*i.mass)),i.accelerate(f.mult(r.mass/i.mass).negate()))}a.done()}}}),n.behavior("sweep-prune",function(e){function s(e,t){return e===t?!1:e>t?e<<16|t&65535:t<<16|e&65535}var t=1,r=function(){return t++},i={x:0,y:1};return{init:function(t){e.init.call(this),this.options.defaults({channel:"collisions:candidates"}),this.options(t),this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists={};for(var e in i)this.intervalLists[e]=[]},connect:function(e){e.on("add:body",this.trackBody,this),e.on("remove:body",this.untrackBody,this),e.on("integrate:velocities",this.sweep,this);var t=e.getBodies();for(var n=0,r=t.length;n<r;++n)this.trackBody({body:t[n]})},disconnect:function(e){e.off("add:body",this.trackBody),e.off("remove:body",this.untrackBody),e.off("integrate:velocities",this.sweep),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this.checkOverlaps()},sortIntervalLists:function(){var e,t,n,r,s,o,u,a,f;for(var l in i){e=this.intervalLists[l],n=0,t=e.length,f=i[l];while(++n<t){s=e[n],o=s.val.get(f),r=n,u=e[r-1],a=u&&u.val.get(f);while(r>0&&(a>o||a===o&&u.type&&!s.type))e[r]=u,r--,u=e[r-1],a=u&&u.val.get(f);e[r]=s}}},getPair:function(e,t,n){var r=s(e.id,t.id);if(r===!1)return null;var i=this.pairs[r];if(!i){if(!n)return null;i=this.pairs[r]={bodyA:e.body,bodyB:t.body,flag:0}}return i},checkOverlaps:function(){var e,t,n,r,s,o,u,a,f,l,c=i.z||i.y||i.x,h=[],p=0,d=[];for(var v in i){e=v==="x",o=this.intervalLists[v],a=-1,u=o.length;while(++a<u){s=o[a],n=s.tracker;if(s.type){f=p;while(--f>=0)r=h[f],r===n?(f<p-1?h[f]=h.pop():h.pop(),p--):(l=this.getPair(n,r,e),l&&(l.flag=e?0:l.flag+1,l.flag===c&&d.push(l)))}else p=h.push(n)}}return d},updateIntervals:function(){var e,t,r=n.scratchpad(),i=r.vector(),s=r.vector(),o=this.tracked,u=o.length;while(--u>=0)e=o[u],t=e.interval,i.clone(e.body.state.pos),s.clone(e.body.aabb()),t.min.val.clone(i).vsub(s),t.max.val.clone(i).vadd(s);r.done()},trackBody:function(e){var t=e.body,s={id:r(),body:t},o={min:{type:!1,val:n.vector(),tracker:s},max:{type:!0,val:n.vector(),tracker:s}};s.interval=o,this.tracked.push(s);for(var u in i)this.intervalLists[u].push(o.min,o.max)},untrackBody:function(e){var t=e.body,n,r,s=this.tracked,o,u;for(var a=0,f=s.length;a<f;++a){o=s[a];if(o.body===t){s.splice(a,1);for(var l in i){u=0,n=this.intervalLists[l];for(var c=0,h=n.length;c<h;++c){r=n[c];if(r===o.interval.min||r===o.interval.max){n.splice(c,1),c--,f--;if(u>0)break;u++}}}break}}},sweep:function(e){var t=this,n;n=t.broadPhase(),n.length&&this._world.emit(this.options.channel,{candidates:n})}}}),n.behavior("verlet-constraints",function(e){var t=2*Math.PI,r={iterations:2};return{init:function(t){e.init.call(this),this.options.defaults(r),this.options(t),this._distanceConstraints=[],this._angleConstraints=[]},connect:function(e){var t=e.integrator();if(t&&t.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';e.on("integrate:positions",this.resolve,this)},disconnect:function(e){e.off("integrate:positions",this.resolve)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(e,t,r,i){var s;return!e||!t?!1:(s={id:n.util.uniqueId("dis-constraint"),type:"dis",bodyA:e,bodyB:t,stiffness:r||.5,targetLength:i||t.state.pos.dist(e.state.pos)},s.targetLengthSq=s.targetLength*s.targetLength,this._distanceConstraints.push(s),s)},angleConstraint:function(e,t,r,i,s){var o;return!e||!t?!1:(o={id:n.util.uniqueId("ang-constraint"),type:"ang",bodyA:e,bodyB:t,bodyC:r,stiffness:i||.5,targetAngle:s||t.state.pos.angle2(e.state.pos,r.state.pos)},this._angleConstraints.push(o),o)},remove:function(e){var t,r,i,s,o;i=n.util.isObject(e),r=i?e.type:e.substr(0,3),t=r==="ang"?this._angleConstraints:this._distanceConstraints;if(i){for(s=0,o=t.length;s<o;++s)if(t[s]===e)return t.splice(s,1),this}else for(s=0,o=t.length;s<o;++s)if(t[s].id===e)return t.splice(s,1),this;return this},resolveAngleConstraints:function(e){var r=this._angleConstraints,i=n.scratchpad(),s=i.transform(),o,u,a,f,l;for(var c=0,h=r.length;c<h;++c){o=r[c],u=o.bodyB.state.pos.angle2(o.bodyA.state.pos,o.bodyC.state.pos),a=u-o.targetAngle;if(!a)continue;a<=-Math.PI?a+=t:a>=Math.PI&&(a-=t),s.setTranslation(o.bodyB.state.pos),a*=-e*o.stiffness,o.bodyA.treatment==="dynamic"&&o.bodyB.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"&&(l=1/(o.bodyA.mass+o.bodyB.mass+o.bodyC.mass)),o.bodyA.treatment==="dynamic"&&(o.bodyB.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"?u=a*(o.bodyB.mass+o.bodyC.mass)*l:o.bodyB.treatment!=="dynamic"?u=a*o.bodyC.mass/(o.bodyC.mass+o.bodyA.mass):u=a*o.bodyB.mass/(o.bodyB.mass+o.bodyA.mass),s.setRotation(u),o.bodyA.state.pos.translateInv(s),o.bodyA.state.pos.rotate(s),o.bodyA.state.pos.translate(s)),o.bodyC.treatment==="dynamic"&&(o.bodyA.treatment==="dynamic"&&o.bodyB.treatment==="dynamic"?u=-a*(o.bodyB.mass+o.bodyA.mass)*l:o.bodyB.treatment!=="dynamic"?u=-a*o.bodyA.mass/(o.bodyC.mass+o.bodyA.mass):u=-a*o.bodyB.mass/(o.bodyB.mass+o.bodyC.mass),s.setRotation(u),o.bodyC.state.pos.translateInv(s),o.bodyC.state.pos.rotate(s),o.bodyC.state.pos.translate(s)),o.bodyB.treatment==="dynamic"&&(o.bodyA.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"?u=a*(o.bodyA.mass+o.bodyC.mass)*l:o.bodyA.treatment!=="dynamic"?u=a*o.bodyC.mass/(o.bodyC.mass+o.bodyB.mass):u=a*o.bodyA.mass/(o.bodyA.mass+o.bodyC.mass),s.setRotation(u).setTranslation(o.bodyA.state.pos),o.bodyB.state.pos.translateInv(s),o.bodyB.state.pos.rotate(s),o.bodyB.state.pos.translate(s),s.setTranslation(o.bodyC.state.pos),o.bodyB.state.pos.translateInv(s),o.bodyB.state.pos.rotateInv(s),o.bodyB.state.pos.translate(s))}i.done()},resolveDistanceConstraints:function(e){var t=this._distanceConstraints,r=n.scratchpad(),i=r.vector(),s,o,u,a;for(var f=0,l=t.length;f<l;++f)s=t[f],i.clone(s.bodyB.state.pos).vsub(s.bodyA.state.pos),o=i.normSq()||Math.random()*1e-4,u=e*s.stiffness*(o-s.targetLengthSq)/o,i.mult(u),a=s.bodyA.treatment!=="dynamic"||s.bodyB.treatment!=="dynamic"?1:s.bodyB.mass/(s.bodyA.mass+s.bodyB.mass),s.bodyA.treatment==="dynamic"&&(s.bodyB.treatment==="dynamic"&&i.mult(a),s.bodyA.state.pos.vadd(i),s.bodyB.treatment==="dynamic"&&i.mult(1/a)),s.bodyB.treatment==="dynamic"&&(s.bodyA.treatment==="dynamic"&&i.mult(1-a),s.bodyB.state.pos.vsub(i));r.done()},shuffleConstraints:function(){this._distanceConstraints=n.util.shuffle(this._distanceConstraints),this._angleConstraints=n.util.shuffle(this._angleConstraints)},resolve:function(){var e=this.options.iterations,t=1/e;for(var n=0;n<e;n++)this.resolveDistanceConstraints(t),this.resolveAngleConstraints(t)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}}),n.integrator("improved-euler",function(e){return{init:function(t){e.init.call(this,t)},integrateVelocities:function(e,t){var n=1-this.options.drag,r=null,i;for(var s=0,o=e.length;s<o;++s)r=e[s],i=r.state,r.treatment!=="static"?(i.old.vel.clone(i.vel),i.old.acc.clone(i.acc),i.vel.vadd(i.acc.mult(t)),n&&i.vel.mult(n),i.acc.zero(),i.old.angular.vel=i.angular.vel,i.angular.vel+=i.angular.acc*t,i.angular.acc=0):(i.vel.zero(),i.acc.zero(),i.angular.vel=0,i.angular.acc=0)},integratePositions:function(e,t){var r=.5*t*t,i=null,s,o=n.scratchpad(),u=o.vector(),a;for(var f=0,l=e.length;f<l;++f)i=e[f],s=i.state,i.treatment!=="static"&&(s.old.pos.clone(s.pos),u.clone(s.old.vel),s.pos.vadd(u.mult(t)).vadd(s.old.acc.mult(r)),s.old.acc.zero(),s.old.angular.pos=s.angular.pos,s.angular.pos+=s.old.angular.vel*t+s.old.angular.acc*r,s.old.angular.acc=0);o.done()}}}),n.renderer("canvas",function(e){if(!t)return{};var r=Math.PI*2,i=function(e,n){var r=t.createElement(e||"div");return n&&(r.innerHTML=n),r},s={debug:!1,metaEl:null,styles:{point:"rgba(80, 50, 100, 0.7)",circle:{strokeStyle:"rgba(70, 50, 100, 0.7)",lineWidth:1,fillStyle:"rgba(44, 105, 44, 0.7)",angleIndicator:"rgba(69, 51, 78, 0.7)"},"convex-polygon":{strokeStyle:"rgba(80, 50, 100, 0.7)",lineWidth:1,fillStyle:"rgba(114, 105, 124, 0.7)",angleIndicator:"rgba(69, 51, 78, 0.7)"}},offset:{x:0,y:0}},o=function(e,t){return n.util.isPlainObject(t)?n.util.extend({},e,t,o):t!==undefined?t:e};return{init:function(r){var u=this;e.init.call(this,r),this.options=n.util.extend({},s,this.options,o),this.options.offset=n.vector(this.options.offset),this.hiddenCanvas=t.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100;if(!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");var a=this.el;a.nodeName.toUpperCase()!=="CANVAS"&&(a=t.createElement("canvas"),this.el.appendChild(a),typeof this.options.el=="string"&&this.el===t.body&&(a.id=this.options.el),this.el=a),a.width=this.options.width,a.height=this.options.height,this.ctx=a.getContext("2d"),this.els={};if(this.options.meta){var f=this.options.metaEl||i();f.className="pjs-meta",this.els.fps=i("span"),this.els.ipf=i("span"),f.appendChild(i("span","fps: ")),f.appendChild(this.els.fps),f.appendChild(i("br")),f.appendChild(i("span","ipf: ")),f.appendChild(this.els.ipf),a.parentNode.insertBefore(f,a)}},setStyle:function(e,t){t=t||this.ctx,n.util.isObject(e)?(t.lineWidth=e.lineWidth,t.strokeStyle=e.lineWidth?e.strokeStyle:"rgba(0,0,0,0)",t.fillStyle=e.fillStyle):(t.fillStyle=t.strokeStyle=e,t.lineWidth=1)},drawCircle:function(e,t,n,i,s){s=s||this.ctx,s.beginPath(),this.setStyle(i,s),s.arc(e,t,n,0,r,!1),s.closePath(),s.stroke(),s.fill()},drawPolygon:function(e,t,n){var r=e[0],i=r.x===undefined?r.get(0):r.x,s=r.y===undefined?r.get(1):r.y,o=e.length;n=n||this.ctx,n.beginPath(),this.setStyle(t,n),n.moveTo(i,s);for(var u=1;u<o;++u)r=e[u],i=r.x===undefined?r.get(0):r.x,s=r.y===undefined?r.get(1):r.y,n.lineTo(i,s);o>2&&n.closePath(),n.stroke(),n.fill()},drawRect:function(e,t,n,r,i,s){var o=n*.5,u=r*.5;s=s||this.ctx,this.setStyle(i,s),s.beginPath(),s.rect(e-o,t-u,n,r),s.closePath(),s.stroke(),s.fill()},drawLine:function(e,t,n,r){var i=e.x===undefined?e.get(0):e.x,s=e.y===undefined?e.get(1):e.y;r=r||this.ctx,r.beginPath(),this.setStyle(n,r),r.moveTo(i,s),i=t.x===undefined?t.get(0):t.x,s=t.y===undefined?t.get(1):t.y,r.lineTo(i,s),r.stroke(),r.fill()},createView:function(e,t){var n,r=e.aabb(),i=r.halfWidth+Math.abs(r.pos.x),s=r.halfHeight+Math.abs(r.pos.y),o=i+1,u=s+1,a=this.hiddenCtx,f=this.hiddenCanvas,l=e.name;return t=t||this.options.styles[l],t.src?(n=new Image,n.src=t.src,t.width&&(n.width=t.width),t.height&&(n.height=t.height),n):(o+=t.lineWidth|0,u+=t.lineWidth|0,f.width=2*i+2+(2*t.lineWidth|0),f.height=2*s+2+(2*t.lineWidth|0),a.save(),a.translate(o,u),l==="circle"?this.drawCircle(0,0,e.radius,t,a):l==="convex-polygon"&&this.drawPolygon(e.vertices,t,a),t.angleIndicator&&(a.beginPath(),this.setStyle(t.angleIndicator,a),a.moveTo(0,0),a.lineTo(i,0),a.closePath(),a.stroke()),a.restore(),n=new Image(f.width,f.height),n.src=f.toDataURL("image/png"),n)},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},beforeRender:function(){this.ctx.clearRect(0,0,this.el.width,this.el.height)},drawBody:function(e,t,n,r){var i=e.state.pos,s=e.aabb();r=r||this.options.offset,n=n||this.ctx,n.save(),n.translate(i.get(0)+r.get(0),i.get(1)+r.get(1)),n.rotate(e.state.angular.pos),n.drawImage(t,-t.width/2,-t.height/2),n.restore(),this.options.debug&&(this.drawRect(s.pos.x,s.pos.y,2*s.x,2*s.y,"rgba(0, 0, 255, 0.3)"),e._debugView=e._debugView||this.createView(e.geometry,"rgba(255, 0, 0, 0.5)"),n.save(),n.translate(i.get(0)+r.get(0),i.get(1)+r.get(1)),n.rotate(e.state.angular.pos),n.drawImage(e._debugView,-e._debugView.width*.5,-e._debugView.height*.5),n.restore())}}}),n.renderer("dom",function(e){if(!t)return{};var n={},r=t.createElement("div"),i=function(t){return t.replace(/(?:^|\s)\w/g,function(e){return e.toUpperCase()})},s=function(t){if(n[t])return n[t];var s=["Webkit","Moz","Ms","O"],o;for(var u=0,a=s.length;u<a;++u){o=s[u]+i(t);if(o in r.style)return n[t]=o}return o in r.style?n[t]=t:!1},o="pjs-",u="px",a=s("transform"),f=function(e,n){var r=t.createElement(e||"div");return n&&(r.innerHTML=n),r},l;return a?l=function(e,t){var n=e.state.pos;t.style[a]="translate("+n.get(0)+"px,"+n.get(1)+"px) rotate("+e.state.angular.pos+"rad)"}:l=function(e,t){var n=e.state.pos;t.style.left=n.get(0)+u,t.style.top=n.get(1)+u},{init:function(t){e.init.call(this,t);var n=this.el;n.style.position="relative",n.style.overflow="hidden",n.style[a]="translateZ(0)",n.style.width=this.options.width+u,n.style.height=this.options.height+u,this.els={};if(t.meta){var r=f();r.className="pjs-meta",this.els.fps=f("span"),this.els.ipf=f("span"),r.appendChild(f("span","fps: ")),r.appendChild(this.els.fps),r.appendChild(f("br")),r.appendChild(f("span","ipf: ")),r.appendChild(this.els.ipf),n.appendChild(r)}},circleProperties:function(e,t){var n=t.aabb();e.style.width=n.halfWidth*2+u,e.style.height=n.halfHeight*2+u,e.style.marginLeft=-n.halfWidth+u,e.style.marginTop=-n.halfHeight+u},createView:function(e){var t=f(),n=e.name+"Properties";return t.className=o+e.name,t.style.position="absolute",t.style.top="0px",t.style.left="0px",this[n]&&this[n](t,e),this.el.appendChild(t),t},connect:function(e){e.on("add:body",this.attach,this),e.on("remove:body",this.detach,this)},disconnect:function(e){e.off("add:body",this.attach),e.off("remove:body",this.detach)},detach:function(e){var t=e.nodeType&&e||e.body&&e.body.view,n=t&&t.parentNode;return t&&n&&n.removeChild(t),this},attach:function(e){var t=e.nodeType&&e||e.body&&e.body.view;return t&&this.el.appendChild(t),this},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},drawBody:l}}),n.renderer("pixi",function(e){if(!t)return{};var r=Math.PI*2,i={debug:!1,metaEl:null,offset:{x:0,y:0},styles:{color:6750105,point:"0xE8900C",circle:{strokeStyle:"0xE8900C",lineWidth:3,fillStyle:"0xD5DE4C",angleIndicator:"0xE8900C"},"convex-polygon":{strokeStyle:"0xE8900C",lineWidth:3,fillStyle:"0xD5DE4C",angleIndicator:"0xE8900C"}}},s=function(e,t){return n.util.isPlainObject(t)?n.util.extend({},e,t,s):t!==undefined?t:e};return{init:function(r){if(typeof PIXI=="undefined")throw"PIXI obj not present - cannot continue ";e.init.call(this,r),this.options=n.util.extend({},i,this.options,s),this.options.offset=n.vector(this.options.offset),this.stage=new PIXI.Stage(this.options.styles.color),this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height),this.meta={},this.el.nodeName=="CANVAS"?this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height,this.el):(this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height),this.el!==null?this.el.appendChild(this.renderer.view):t.body.appendChild(this.renderer.view))},loadSpritesheets:function(e,t){if(!e instanceof Array)throw"Spritesheets must be defined in arrays";var n=new PIXI.AssetLoader(e);n.load();var r=this;n.on("onComplete",function(e){r.assetsLoaded=!0,t()})},drawBody:function(e){if(e.view!==null){var t=e.view,n=e.state.pos.get(0),r=e.state.pos.get(1),i=e.state.angular.pos;t.position.x=n,t.position.y=r,t.rotation=i,this.renderer.render(this.stage)}},createCircle:function(e,t,n,r){var i=new PIXI.Graphics;return i.beginFill(r.fillStyle),i.lineStyle(r.lineWidth,r.strokeStyle),i.drawCircle(e,t,n),i.pivot.x=e/2+n/2,i.pivot.y=t/2+n/2,i},createPolygon:function(e,t){var n=e[0],r=n.x===undefined?n.get(0):n.x,i=n.y===undefined?n.get(1):n.y,s=e.length,o={x:r,y:i},u=new PIXI.Graphics;u.beginFill(t.fillStyle),u.lineStyle(t.lineWidth,t.strokeStyle),u.moveTo(r,i);for(var a=1;a<s;++a)n=e[a],r=n.x===undefined?n.get(0):n.x,i=n.y===undefined?n.get(1):n.y,u.lineTo(r,i);return s>2&&u.lineTo(o.x,o.y),u.endFill(),u},createLine:function(e,t,n){var r=e.x===undefined?e.get(0):e.x,i=e.y===undefined?e.get(1):e.y,s=new PIXI.Graphics;return s.beginFill(n.fillStyle),s.lineStyle(n.lineWidth,n.strokeStyle),s.moveTo(r,i),r=t.x===undefined?t.get(0):t.x,i=t.y===undefined?t.get(1):t.y,s.lineTo(r,i),s.endFill(),s},createView:function(e){var t=null,n=e.aabb(),r=n.halfWidth+Math.abs(n.pos.x),i=n.halfHeight+Math.abs(n.pos.y),s=r+1,o=i+1,u=e.name,a=a||this.options.styles[u];s+=a.lineWidth|0,o+=a.lineWidth|0,u==="circle"?t=this.createCircle(s,o,e.radius,a):u==="convex-polygon"&&(t=this.createPolygon(e.vertices,a)),a.angleIndicator&&(t.beginFill(a.angleIndicator),t.moveTo(s/2,5+a.lineWidth),t.lineTo(s/2+e.radius/2,e.radius),t.endFill());if(t)return this.stage.addChild(t),t;throw"Invalid view name passed."},drawMeta:function(e){if(!this.meta.loaded){var t={font:"18px Snippet",fill:"white",align:"left"};this.meta.fps=new PIXI.Text("FPS: "+e.fps.toFixed(2),t),this.meta.fps.position.x=15,this.meta.fps.position.y=5,this.meta.ipf=new PIXI.Text("IPF: "+e.ipf,t),this.meta.ipf.position.x=15,this.meta.ipf.position.y=30,this.stage.addChild(this.meta.fps),this.stage.addChild(this.meta.ipf),this.meta.loaded=!0}else this.meta.fps.setText("FPS: "+e.fps.toFixed(2)),this.meta.ipf.setText("IPF: "+e.ipf)},beforeRender:function(){},createDisplay:function(e,t){var n=null,r=null;switch(e){case"sprite":return r=PIXI.Texture.fromImage(t.texture),n=new PIXI.Sprite(r),t.anchor&&(n.anchor.x=t.anchor.x,n.anchor.y=t.anchor.y),t.container?t.container.addChild(n):this.stage.addChild(n),n;case"movieclip":if(!this.assetsLoaded)throw"No assets have been loaded. Use loadSpritesheet() first";var i=[],s=0;for(s;s<t.frames.length;s++)r=PIXI.Texture.fromFrame(t.frames[s]),i.push(r);return n=new PIXI.MovieClip(i),t.anchor&&(n.anchor.x=t.anchor.x,n.anchor.y=t.anchor.y),t.container?t.container.addChild(n):this.stage.addChild(n),n;default:throw"Invalid PIXI.DisplayObject passed"}},centerAnchor:function(e){e!==null&&(e.anchor.x=.5,e.anchor.y=.5)}}}),n}),define("modules/sprite",[],function(){function e(e,t){this._frames=[],this._offset={x:0,y:0},this._index=0,this._past=0;for(var n=0,r=e.length;n<r;++n)this.addImage(e[n]);this.fps(t||60)}return e.prototype={addImage:function(e){var t=e;typeof e=="string"&&(t=new Image,t.src=e),this._len=this._frames.push(t)},drawTo:function(e,t,n,r,i){var s=this._frames[this.nextFrame()];t|=0,n|=0,r=+r,e.save(),e.translate(t+this._offset.x,n+this._offset.y),i&&e.scale(-1,1),e.rotate(r),e.drawImage(s,-s.width*.5,-s.height*.5),e.restore()},nextFrame:function(){var e=this._index,t=Date.now();return t-this._past>this._mspf&&(e++,e>=this._len&&(e=0),this._index=e,this._past=t),e},offset:function(e){return e===undefined?this._offset:(this._offset.x=e.x|0,this._offset.y=e.y|0,this)},fps:function(e){return e===undefined?this._fps:(this._fps=e|0,this._mspf=1e3/e|0,this)}},e}),define("modules/multicanvas-renderer",["physicsjs"],function(e){e.renderer("multicanvas","canvas",function(t){return{init:function(e){t.init.call(this,e),this.layers={},this.addLayer("main",this.el),this.resize(this.options.width,this.options.height)},addLayer:function(t,n,r){var i=this,s=[],o=e.util.extend({},this.options.styles),u={id:t,el:n||document.createElement("canvas"),options:e.util.options({width:this.el.width,height:this.el.height,manual:!1,autoResize:!0,follow:null,scale:1})(r)};if(t in this.layers)throw'Layer "'+t+'" already added.';return this.el.parentNode.appendChild(u.el),u.el.className+=" physics-layer-"+u.id,u.ctx=u.el.getContext("2d"),u.ctx.scale(1,1),u.el.width=u.options.width,u.el.height=u.options.height,u.reset=function(e){s=e||[]},u.addToStack=function(t){return e.util.isArray(t)?s.push.apply(s,t):s.push(t),u},u.removeFromStack=function(t){var n,r;if(e.util.isArray(t))for(n=0,r=t.length;n<r;++n)u.removeFromStack(t[n]);else n=e.util.indexOf(s,t),n>-1&&s.splice(n,1);return u},u.render=function(t){var n,r=e.scratchpad(),a=r.vector().set(0,0),f=u.options.scale,l;if(u.options.manual)return r.done(),u;u.options.offset&&(u.options.offset==="center"?a.add(u.el.width*.5,u.el.height*.5).mult(1/f):a.vadd(u.options.offset).mult(1/f)),u.options.follow&&a.vsub(u.options.follow.state.pos),t!==!1&&u.ctx.clearRect(0,0,u.el.width,u.el.height),u.ctx.save(),u.ctx.scale(f,f);for(var c=0,h=s.length;c<h;++c)n=s[c],n.hidden||(l=n.view||(n.view=i.createView(n.geometry,n.styles||o[n.geometry.name])),i.drawBody(n,n.view,u.ctx,a));return u.ctx.restore(),r.done(),u},this.layers[t]=u,u},resize:function(e,t){var n;for(var r in this.layers)n=this.layers[r],n.options.autoResize&&(n.el.width=e,n.el.height=t)},render:function(e,t){var n,r,i;this._world.emit("beforeRender",{renderer:this,meta:t}),this.options.meta&&this.drawMeta(t);for(var s in this.layers)this.layers[s].render();return this}}})}),define("mediators/boilerplate",["require","when","plugins/domready","moddef","hammer","physicsjs","modules/sprite","modules/multicanvas-renderer"],function(e,t,n,r,i,s,o,u){function a(e){window.console.error(e)}function l(e){return e>=0?1:-1}function c(e,t){var n="000000000"+e;return n.substr(n.length-t)}function h(e,t,n){var r=e.className.split(" "),i=r.indexOf(t);return n===i>-1?n:i>-1?(r.splice(i,1),e.className=r.join(" "),!1):(e.className+=" "+t,!0)}var f=function(t,n){var r=2*(Math.random()+Math.random()+Math.random())-3;return r*n+t},p=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(e=e.offsetParent);return{left:t,top:n}},d=function(e,t){var n=p(t||e.target),r=e.changedTouches&&e.changedTouches[0]||e,i=r.pageX-n.left,s=r.pageY-n.top;return{x:i,y:s}},v=r({constructor:function(){var e=this;e.scale=window.innerWidth>1080?1:window.innerWidth/1080,e.minScale=.05,e.maxScale=1,e.waterTog=!0,e.initEvents(),n(function(){e.onDomReady(),e.resolve("domready")})},initEvents:function(){function t(){e.scale=Math.max(e.minScale,Math.min(e.maxScale,e.scale)),e.emit("scale",e.scale)}var e=this;e.after("domready",function(){function p(){a.x=u.right-u.left,a.y=u.down-u.up,e.emit("thrust",a)}var n,r=document.getElementById("viewport");r.tabIndex=0,r.focus();var o=i(r);o.on("mousewheel",function(n){var r=Math.min(Math.abs(n.wheelDelta)/50,.2)*l(n.wheelDelta);e.scale*=Math.pow(2,r),t(),n.preventDefault()}),o.on("transformstart",function(t){n=e.scale,t.preventDefault()}),o.on("transform",function(r){e.scale=n*r.gesture.scale,t(),r.preventDefault()}),o.on("touch",function(t){t.preventDefault(),e.emit("touch",t)}),o.on("touchstart",function(e){r.focus(),e.preventDefault()}),o.on("drag",function(t){t.preventDefault(),e.emit("drag",t)}),o.on("release",function(t){t.preventDefault(),e.emit("release",t)});var u={up:0,down:0,left:0,right:0},a={x:0,y:0},f=document.getElementById("ctrl-booster"),c=i(document.getElementById("controls"));c.on("touch",function(n){n.preventDefault(),n.target.id==="ctrl-brakes"?e.emit("brakes"):n.target.id==="ctrl-grab-mode"?e.grabMode=h(n.target,"on"):n.target.id==="ctrl-zoom-in"?(e.scale*=2,t()):n.target.id==="ctrl-zoom-out"?(e.scale*=.5,t()):n.target.id==="ctrl-sheep"?e.emit("sheep-toggle",h(n.target,"on")):n.target.id==="ctrl-water"?e.waterTog=h(n.target,"on"):n.target.id==="ctrl-booster"&&(e.booster=h(n.target,"on"),e.emit("thrust",a))}),r.addEventListener("keydown",function(t){switch(t.keyCode){case 38:case 87:u.up=100,p();break;case 40:case 83:u.down=100,p();break;case 37:case 65:u.left=100,p();break;case 39:case 68:u.right=100,p();break;case 32:e.booster=!0,h(f,"on",!0),p()}return!1}),r.addEventListener("keyup",function(t){switch(t.keyCode){case 38:case 87:u.up=0,p();break;case 40:case 83:u.down=0,p();break;case 37:case 65:u.left=0,p();break;case 39:case 68:u.right=0,p();break;case 32:e.booster=!1,h(f,"on",!1),p()}return!1}),window.addEventListener("resize",function(){e.viewWidth=window.innerWidth,e.viewHeight=window.innerHeight,e.emit("resize")},!0);var v=document.getElementById("joystick"),m=i(v),g=v.height*.5,y=v.width*.5;m.on("touch drag",s.util.throttle(function(t){var n=d(t.gesture.center,t.target);a.x=n.x-y,a.y=n.y-g,e.emit("thrust",a)}),50),m.on("release",function(t){e.emit("thrust",{x:0,y:0})}),e.on("touch",function(t){e.emit("dismiss-instructions"),e.off(t.topic,t.handler)}),e.on("thrust",function(t){e.emit("dismiss-instructions"),e.off(t.topic,t.handler)})})},initPhysics:function(t){var n=this,r,i,o=s.renderer("multicanvas",{el:"physics",width:n.viewWidth,height:n.viewHeight,styles:{circle:{strokeStyle:"#1a1a1a",lineWidth:0,fillStyle:"#1a1a1a",angleIndicator:"rgba(0,0,0,0)"}}});this.world=t,this.renderer=o,t.add(o),t.on("step",function(){t.render()}),n.on("resize",function(){o.resize(n.viewWidth,n.viewHeight)}),s.util.ticker.on(function(e,n){t.step(e)}),s.util.ticker.start();var u=[];for(r=0,i=5;r<i;++r)u.push(s.body("circle",{x:Math.random()*n.viewWidth,y:Math.random()*n.viewHeight,vx:Math.random()*.1,vy:Math.random()*.1,radius:12,classed:"sheep",styles:{src:e.toUrl("../../images/Sheep.png")}}));n.on("sheep-toggle",function(e,t){for(r=0,i=u.length;r<i;++r)u[r].hidden=!t}),t.add([s.behavior("body-collision-detection").applyTo(u),s.behavior("sweep-prune"),s.behavior("body-impulse-response")]);var a=n.addRocket(0,0),f=o.layers.main.render;o.layers.main.addToStack(u).options({scale:n.scale,offset:"center"}),o.layers.main.render=function(){var e=o.layers.main,t=e.ctx,n=s.scratchpad(),r=n.vector().set(0,0),i=e.el.width,u=e.el.height,l=e.options.scale,c=a.edge.body.state.pos;e.options.offset==="center"?r.add(i*.5,u*.5).mult(1/l):r.vadd(e.options.offset).mult(1/l),e.options.follow&&r.vsub(e.options.follow.state.pos),t.clearRect(0,0,i,u),t.save(),t.scale(l,l),a.drawBgTo(c.get(0)+r.get(0),c.get(1)+r.get(1),t,o),t.restore(),f(!1),t.save(),t.scale(l,l),a.drawTo(c.get(0)+r.get(0),c.get(1)+r.get(1),t,o),t.restore(),n.done()};var l=!1,c=s.vector(),h=s.vector(),p=s.vector(),d=16;n.on("touch",function(e,t){var r=t.gesture.center;r.x=r.pageX,r.y=r.pageY,c.clone(r).sub(n.viewWidth/2,n.viewHeight/2).mult(1/n.scale),a.outerAABB.contains(c)&&(l=!0,c.clone(a.pos),h.clone(c))}),n.on("thrust",function(e,t){p.clone(t).normalize(),n.booster&&p.add(0,-4),a.thrust.clone(t),a.booster=n.booster}),n.on("drag",s.util.throttle(function(e,t){l&&h.clone(c).add(t.gesture.deltaX/n.scale,t.gesture.deltaY/n.scale)},d)),n.on("release",function(e,t){l=!1,a.thrust.zero(),n.emit("thrust",a.thrust)}),n.on("scale",function(e,t){o.layers.main.options({scale:t})}),n.on("brakes",function(){a.edge.body.state.vel.zero()}),t.on("integrate:positions",function(e){a.moveTo(a.pos),l?n.grabMode?a.edge.body.state.vel.clone(h).vsub(a.pos).mult(1/d):(a.edge.body.state.acc.clone(h).vsub(a.edge.body.state.pos).normalize().mult(1e-4),n.emit("thrust",a.edge.body.state.acc)):p.equals(s.vector.zero)||a.edge.body.state.acc.clone(p).mult(1e-4)}),a.edge.body.treatment="kinematic",t.add([a.edge.body,a.constr]),a.edge.applyTo(u),t.add(u),t.add(a.edge);var v=o.addLayer("rocket-cam",null,{width:400,height:400,autoResize:!1,follow:a.edge.body,offset:s.vector(200,160)}),m=v.render;v.render=function(){var e=v.ctx,t=a.aabb,n=v.options.offset;e.clearRect(0,0,v.el.width,v.el.height),a.drawBgTo(n.get(0),n.get(1),e,o),m(!1),a.drawTo(n.get(0),n.get(1),e,o)},v.addToStack(u);var g=[],y=0,b=[],w=s.util.throttle(function(){if(!n.waterTog)return;var e=s.body("circle",{tag:"water",x:-45,y:0,vx:.04,radius:3,view:b[y]});e.state.pos.vadd(a.edge.body.state.pos),e.state.vel.vadd(a.edge.body.state.vel),g.push(e),t.add(e),o.layers.main.addToStack(e),v.addToStack(e),a.edge.applyTo(g.concat(u)),y=y>1?0:y+1},250);for(r=0,i=3;r<i;++r)b[r]=new Image,b[r].src=e.toUrl("../../images/Water-"+(r+1)+".png");t.on("step",w),t.on("collisions:detected",function(e){var n,r;for(var i=0,f=e.collisions.length;i<f;++i){n=e.collisions[i];if(n.bodyA.tag==="water"&&n.bodyB===a.edge.body||n.bodyB.tag==="water"&&n.bodyA===a.edge.body)r=n.bodyA.tag==="water"?n.bodyA:n.bodyB,t.remove(r),g.splice(s.util.indexOf(g,r),1),a.edge.applyTo(g.concat(u)),o.layers.main.removeFromStack(r),v.removeFromStack(r)}});var E=document.getElementById("speed-meter"),S=s.util.throttle(function(){var e=a.edge.body.state.vel.norm()*1e3;E.innerHTML=e.toFixed(1)+" px/s"},200),x={},T=a.outerAABB.halfWidth(),N=a.outerAABB.halfHeight();t.on("step",function(){var e=.5/n.scale,t,r,i=a.pos.get(0),o=a.pos.get(1),u=s.scratchpad(),f=u.vector().set(0,0),l;x.maxX=n.viewWidth*e+T,x.minX=-x.maxX,x.maxY=n.viewHeight*e+N,x.minY=-x.maxY,i<=x.minX?f.add(x.maxX-x.minX,0):i>x.maxX&&f.sub(x.maxX-x.minX,0),o<=x.minY?f.add(0,x.maxY-x.minY):o>x.maxY&&f.sub(0,x.maxY-x.minY);if(!f.equals(s.vector.zero)){a.pos.vadd(f),a.edge.body.state.old.pos.vadd(f),a.moveTo(a.pos),l=a.edge.getTargets();for(t=0,r=l.length;t<r;++t)l[t].state.pos.vadd(f),l[t].state.old.pos.vadd(f)}u.done()}),t.on("step",S)},addRocket:function(t,n){var r=s.aabb({pos:{x:t,y:n},halfWidth:50,halfHeight:100}),i=s.behavior("edge-collision-detection",{aabb:r,restitution:.4,cof:.8}).applyTo([]),u={lineWidth:0,strokeStyle:"black",fillStyle:"rgba(200, 200, 200, 1)"},a=s.aabb(0,0,243,549),f=new Image,l=new Image,c=(new o([e.toUrl("../../images/Fire-1.png"),e.toUrl("../../images/Fire-2.png"),e.toUrl("../../images/Fire-3.png")])).offset({x:-5,y:3}).fps(20),h=(new o([e.toUrl("../../images/Small-Fire-1.png"),e.toUrl("../../images/Small-Fire-2.png"),e.toUrl("../../images/Small-Fire-3.png")])).fps(20),p=Math.PI*.5;f.src=e.toUrl("../../images/Rocket.png"),l.src=e.toUrl("../../images/Rocket-bg.png");var d={aabb:r,thrust:s.vector(),booster:!1,outerAABB:a,edge:i,pos:i.body.state.pos,moveTo:function(e){return d.pos.clone(e),d.aabb._pos.clone(e),d.outerAABB._pos.clone(e).add(0,90),d.edge.setAABB(d.aabb),d},drawTo:function(e,t,n,r){var i;n.save(),n.translate(e,t+90),d.thrust.get(1)>0?(h.drawTo(n,-45,-311,-p),h.drawTo(n,46,-311,-p,!0)):d.thrust.get(1)<0&&(h.drawTo(n,-40,147,p,!0),h.drawTo(n,42,148,p)),d.thrust.get(0)>0?h.drawTo(n,-130,-89,0,!0):d.thrust.get(0)<0&&h.drawTo(n,130,-89,0),n.drawImage(f,-f.width/2,-f.height/2),d.booster&&c.drawTo(n),n.restore()},drawBgTo:function(e,t,n,r){n.save(),n.translate(e,t+90),n.drawImage(l,-l.width/2,-l.height/2),n.restore()}};return d.moveTo({x:t,y:n}),d},initJoystick:function(n){function c(e,t){var n=e.norm();return n===0?e:e.mult(Math.min(t,n)/n)}function h(e,t){a.clone(t),c(a,o*.5-49),a.add(o*.5,u*.5),i.clearRect(0,0,o,u),i.drawImage(l,-1,-1),i.save(),i.translate(a.get(0),a.get(1)),i.drawImage(f,-f.width*.5,-f.height*.5),i.restore()}var r=this,i=n.getContext("2d"),o=n.width,u=n.height,a=s.vector(),f=new Image,l=new Image;t.map([f,l],function(e){var n=t.defer();return e.onload=n.resolve,n.promise}).then(function(){r.on("thrust",h),h(null,a)}),f.src=e.toUrl("../../images/Joystick.png"),l.src=e.toUrl("../../images/Joystick-bg.png")},onDomReady:function(){var e=this;e.viewWidth=window.innerWidth,e.viewHeight=window.innerHeight,s(e.initPhysics.bind(e)),e.initJoystick(document.getElementById("joystick"));var t=document.getElementById("instructions");t.style.opacity="1",e.on("dismiss-instructions",function(){t.style.opacity="0",setTimeout(function(){t=document.getElementById("direction"),t.style.opacity="1",setTimeout(function(){t.style.opacity="0"},3e4)},15e3)})}},["events"]);return new v}),require(["config/require-config"],function(){require(["mediators/boilerplate"])}),define("page-boilerplate",function(){}),define("page-boilerplate",function(){});