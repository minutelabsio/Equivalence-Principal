/**
 * PhysicsJS v1.0.0-rc1 - 2014-03-23
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2014 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

(function(e,t){typeof define=="function"&&define.amd?define(["physicsjs"],t):typeof exports=="object"?module.exports=t.apply(e,["physicsjs"].map(require)):t.call(e,e.Physics)})(this,function(e){return e.behavior("verlet-constraints",function(t){var n=2*Math.PI,r={iterations:2};return{init:function(e){t.init.call(this),this.options.defaults(r),this.options(e),this._distanceConstraints=[],this._angleConstraints=[]},connect:function(e){var t=e.integrator();if(t&&t.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';e.on("integrate:positions",this.resolve,this)},disconnect:function(e){e.off("integrate:positions",this.resolve)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(t,n,r,i){var s;return!t||!n?!1:(s={id:e.util.uniqueId("dis-constraint"),type:"dis",bodyA:t,bodyB:n,stiffness:r||.5,targetLength:i||n.state.pos.dist(t.state.pos)},s.targetLengthSq=s.targetLength*s.targetLength,this._distanceConstraints.push(s),s)},angleConstraint:function(t,n,r,i,s){var o;return!t||!n?!1:(o={id:e.util.uniqueId("ang-constraint"),type:"ang",bodyA:t,bodyB:n,bodyC:r,stiffness:i||.5,targetAngle:s||n.state.pos.angle2(t.state.pos,r.state.pos)},this._angleConstraints.push(o),o)},remove:function(t){var n,r,i,s,o;i=e.util.isObject(t),r=i?t.type:t.substr(0,3),n=r==="ang"?this._angleConstraints:this._distanceConstraints;if(i){for(s=0,o=n.length;s<o;++s)if(n[s]===t)return n.splice(s,1),this}else for(s=0,o=n.length;s<o;++s)if(n[s].id===t)return n.splice(s,1),this;return this},resolveAngleConstraints:function(t){var r=this._angleConstraints,i=e.scratchpad(),s=i.transform(),o,u,a,f,l;for(var c=0,h=r.length;c<h;++c){o=r[c],u=o.bodyB.state.pos.angle2(o.bodyA.state.pos,o.bodyC.state.pos),a=u-o.targetAngle;if(!a)continue;a<=-Math.PI?a+=n:a>=Math.PI&&(a-=n),s.setTranslation(o.bodyB.state.pos),a*=-t*o.stiffness,o.bodyA.treatment==="dynamic"&&o.bodyB.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"&&(l=1/(o.bodyA.mass+o.bodyB.mass+o.bodyC.mass)),o.bodyA.treatment==="dynamic"&&(o.bodyB.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"?u=a*(o.bodyB.mass+o.bodyC.mass)*l:o.bodyB.treatment!=="dynamic"?u=a*o.bodyC.mass/(o.bodyC.mass+o.bodyA.mass):u=a*o.bodyB.mass/(o.bodyB.mass+o.bodyA.mass),s.setRotation(u),o.bodyA.state.pos.translateInv(s),o.bodyA.state.pos.rotate(s),o.bodyA.state.pos.translate(s)),o.bodyC.treatment==="dynamic"&&(o.bodyA.treatment==="dynamic"&&o.bodyB.treatment==="dynamic"?u=-a*(o.bodyB.mass+o.bodyA.mass)*l:o.bodyB.treatment!=="dynamic"?u=-a*o.bodyA.mass/(o.bodyC.mass+o.bodyA.mass):u=-a*o.bodyB.mass/(o.bodyB.mass+o.bodyC.mass),s.setRotation(u),o.bodyC.state.pos.translateInv(s),o.bodyC.state.pos.rotate(s),o.bodyC.state.pos.translate(s)),o.bodyB.treatment==="dynamic"&&(o.bodyA.treatment==="dynamic"&&o.bodyC.treatment==="dynamic"?u=a*(o.bodyA.mass+o.bodyC.mass)*l:o.bodyA.treatment!=="dynamic"?u=a*o.bodyC.mass/(o.bodyC.mass+o.bodyB.mass):u=a*o.bodyA.mass/(o.bodyA.mass+o.bodyC.mass),s.setRotation(u).setTranslation(o.bodyA.state.pos),o.bodyB.state.pos.translateInv(s),o.bodyB.state.pos.rotate(s),o.bodyB.state.pos.translate(s),s.setTranslation(o.bodyC.state.pos),o.bodyB.state.pos.translateInv(s),o.bodyB.state.pos.rotateInv(s),o.bodyB.state.pos.translate(s))}i.done()},resolveDistanceConstraints:function(t){var n=this._distanceConstraints,r=e.scratchpad(),i=r.vector(),s,o,u,a;for(var f=0,l=n.length;f<l;++f)s=n[f],i.clone(s.bodyB.state.pos).vsub(s.bodyA.state.pos),o=i.normSq()||Math.random()*1e-4,u=t*s.stiffness*(o-s.targetLengthSq)/o,i.mult(u),a=s.bodyA.treatment!=="dynamic"||s.bodyB.treatment!=="dynamic"?1:s.bodyB.mass/(s.bodyA.mass+s.bodyB.mass),s.bodyA.treatment==="dynamic"&&(s.bodyB.treatment==="dynamic"&&i.mult(a),s.bodyA.state.pos.vadd(i),s.bodyB.treatment==="dynamic"&&i.mult(1/a)),s.bodyB.treatment==="dynamic"&&(s.bodyA.treatment==="dynamic"&&i.mult(1-a),s.bodyB.state.pos.vsub(i));r.done()},shuffleConstraints:function(){this._distanceConstraints=e.util.shuffle(this._distanceConstraints),this._angleConstraints=e.util.shuffle(this._angleConstraints)},resolve:function(){var e=this.options.iterations,t=1/e;for(var n=0;n<e;n++)this.resolveDistanceConstraints(t),this.resolveAngleConstraints(t)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}}),e});