/**
 * PhysicsJS v1.0.0-rc1 - 2014-03-23
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2014 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

(function(e,t){typeof define=="function"&&define.amd?define(["physicsjs"],t):typeof exports=="object"?module.exports=t.apply(e,["physicsjs"].map(require)):t.call(e,e.Physics)})(this,function(e){return e.behavior("sweep-prune",function(t){function s(e,t){return e===t?!1:e>t?e<<16|t&65535:t<<16|e&65535}var n=1,r=function(){return n++},i={x:0,y:1};return{init:function(e){t.init.call(this),this.options.defaults({channel:"collisions:candidates"}),this.options(e),this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists={};for(var e in i)this.intervalLists[e]=[]},connect:function(e){e.on("add:body",this.trackBody,this),e.on("remove:body",this.untrackBody,this),e.on("integrate:velocities",this.sweep,this);var t=e.getBodies();for(var n=0,r=t.length;n<r;++n)this.trackBody({body:t[n]})},disconnect:function(e){e.off("add:body",this.trackBody),e.off("remove:body",this.untrackBody),e.off("integrate:velocities",this.sweep),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this.checkOverlaps()},sortIntervalLists:function(){var e,t,n,r,s,o,u,a,f;for(var l in i){e=this.intervalLists[l],n=0,t=e.length,f=i[l];while(++n<t){s=e[n],o=s.val.get(f),r=n,u=e[r-1],a=u&&u.val.get(f);while(r>0&&(a>o||a===o&&u.type&&!s.type))e[r]=u,r--,u=e[r-1],a=u&&u.val.get(f);e[r]=s}}},getPair:function(e,t,n){var r=s(e.id,t.id);if(r===!1)return null;var i=this.pairs[r];if(!i){if(!n)return null;i=this.pairs[r]={bodyA:e.body,bodyB:t.body,flag:0}}return i},checkOverlaps:function(){var e,t,n,r,s,o,u,a,f,l,c=i.z||i.y||i.x,h=[],p=0,d=[];for(var v in i){e=v==="x",o=this.intervalLists[v],a=-1,u=o.length;while(++a<u){s=o[a],n=s.tracker;if(s.type){f=p;while(--f>=0)r=h[f],r===n?(f<p-1?h[f]=h.pop():h.pop(),p--):(l=this.getPair(n,r,e),l&&(l.flag=e?0:l.flag+1,l.flag===c&&d.push(l)))}else p=h.push(n)}}return d},updateIntervals:function(){var t,n,r=e.scratchpad(),i=r.vector(),s=r.vector(),o=this.tracked,u=o.length;while(--u>=0)t=o[u],n=t.interval,i.clone(t.body.state.pos),s.clone(t.body.aabb()),n.min.val.clone(i).vsub(s),n.max.val.clone(i).vadd(s);r.done()},trackBody:function(t){var n=t.body,s={id:r(),body:n},o={min:{type:!1,val:e.vector(),tracker:s},max:{type:!0,val:e.vector(),tracker:s}};s.interval=o,this.tracked.push(s);for(var u in i)this.intervalLists[u].push(o.min,o.max)},untrackBody:function(e){var t=e.body,n,r,s=this.tracked,o,u;for(var a=0,f=s.length;a<f;++a){o=s[a];if(o.body===t){s.splice(a,1);for(var l in i){u=0,n=this.intervalLists[l];for(var c=0,h=n.length;c<h;++c){r=n[c];if(r===o.interval.min||r===o.interval.max){n.splice(c,1),c--,f--;if(u>0)break;u++}}}break}}},sweep:function(e){var t=this,n;n=t.broadPhase(),n.length&&this._world.emit(this.options.channel,{candidates:n})}}}),e});